<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flip Cards â€“ VIZKOR Korean Nouns (Categorized)</title>
  <style>
    :root{
      --bg-1:#03121f; --bg-2:#0a1e2e;
      --ice-1:#ecfeff; --ice-2:#dbeafe; --ice-3:#bae6fd;
      --text:#eef6ff; --muted:#a9c3d9;
      --accent:#38bdf8; --accent-2:#0ea5e9;
      --cyan:#67e8f9; --cyan-2:#22d3ee; --navy:#0b2440;
      --ring:0 0 18px rgba(56,189,248,.55), 0 0 32px rgba(103,232,249,.35);
      --border:1px solid rgba(103,232,249,.30);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif; color:var(--text);
      min-height:100vh; display:flex; flex-direction:column; align-items:center; gap:12px;
      background:
        radial-gradient(1200px 800px at 5% -10%, rgba(56,189,248,.18), transparent 60%),
        radial-gradient(1200px 800px at 120% 110%, rgba(103,232,249,.16), transparent 60%),
        linear-gradient(180deg, var(--bg-1), #061a2b 65%, #04121e);
      position:relative; isolation:isolate; padding:22px 16px 42px;
    }
    body::before{
      content:""; position:fixed; inset:-20%;
      background: conic-gradient(from 200deg at 60% 40%, rgba(186,230,253,.12), rgba(34,211,238,.10), rgba(56,189,248,.14), rgba(186,230,253,.10), rgba(34,211,238,.10));
      filter:blur(48px); animation: drift 20s linear infinite; z-index:-1; opacity:.9;
    }
    @keyframes drift{0%{transform:translate3d(0,0,0) rotate(0) scale(1)}50%{transform:translate3d(-3%,1%,0) rotate(10deg) scale(1.05)}100%{transform:translate3d(0,0,0) rotate(0) scale(1)}}

    header{text-align:center}
    .title{
      margin:0; font-size:2.2rem; font-weight:900; letter-spacing:2px; text-transform:uppercase;
      background:linear-gradient(180deg, var(--ice-1), var(--ice-2) 55%, var(--ice-3));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      text-shadow:0 0 10px rgba(255,255,255,.75),0 0 24px rgba(56,189,248,.45);
    }
    .subtitle{ margin:4px 0 0; color:var(--muted); font-weight:600 }
    .progress{ margin-top:6px; font-weight:800; color:var(--ice-2) }

    .toolbar {
        width: min(520px, 94vw);
        margin-top: 10px;
        padding: 15px;
        border-radius: 18px;
        background: linear-gradient(180deg, rgba(10,30,46,.86), rgba(7,22,36,.94));
        border: var(--border);
        box-shadow: var(--ring);
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* === Book filter tabs === */
    .book-tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      appearance:none; border:1px solid rgba(186,230,253,.35);
      background:#061725; color:var(--ice-2);
      padding:8px 12px; border-radius:10px; font-weight:800; cursor:pointer;
      transition:.15s ease;
    }
    .tab:hover{ filter:brightness(1.07) }
    .tab.active{
      border:none; color:#072235;
      background:linear-gradient(90deg, var(--cyan), var(--accent));
      box-shadow:0 6px 18px rgba(56,189,248,.35);
    }

    .toolbar label { color: var(--ice-2); font-weight: 600; margin-bottom: 5px; display: block; }
    .toolbar select {
        width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(186,230,253,.3);
        background: #061725; color: var(--ice-1); font-size: 1rem; appearance: none;
        -webkit-appearance: none; -moz-appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg fill="%23dbeafe" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
        background-repeat: no-repeat; background-position: right 8px top 50%; background-size: 24px auto; cursor: pointer;
    }

    .stage{ width:min(520px, 94vw); height:450px; display:flex; align-items:center; justify-content:center; margin-top:10px; }
    .flip{ perspective:1200px; width:100%; height:100%; }
    .card{ position:relative; width:100%; height:100%; transform-style:preserve-3d; transition: transform .75s cubic-bezier(.2,.7,.2,1); }
    .flipped .card{ transform:rotateY(180deg); }

    .face{ position:absolute; inset:0; border-radius:18px; backface-visibility:hidden; overflow:hidden; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; text-align:center; padding:18px; }
    .front{ color:#0c253a; background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.88)); border:1px solid rgba(255,255,255,.65); box-shadow:0 12px 26px rgba(2,12,22,.45); padding-top:64px; }
    .back{ transform:rotateY(180deg); background: linear-gradient(180deg, rgba(10,30,46,.86), rgba(7,22,36,.94)); border:var(--border); box-shadow:var(--ring); }

    .ko{ font-size:2.6rem; font-weight:900; letter-spacing:.5px; text-shadow:0 1px 0 rgba(255,255,255,.7); color:#0c253a }

    .ko-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; width:min(460px,96%); }
    .play-base{ appearance:none; border:none; cursor:pointer; border-radius:10px; padding:10px 14px; font-weight:900; color:#072235; background:linear-gradient(90deg, var(--cyan), var(--accent)); box-shadow:0 6px 18px rgba(56,189,248,.35); }
    .play-base:hover{ filter:brightness(1.08) }

    .enhead{ font-size:1.1rem; font-weight:900; color:var(--ice-1); margin-top:6px; text-align:left; width:min(460px,96%); }

    .ko-big{ font-size: 2rem; line-height: 1.15; text-align: center; width: 100%; margin: 2px 0 4px; font-weight: 900; letter-spacing: .5px; color: var(--ice-1); }
    @media (max-width:420px){ .ko-big{ font-size:1.8rem; } }

    .meta{ font-weight:800; color:var(--ice-3); opacity:.9 }

    .enlines{ width:min(460px,96%); margin:6px auto 0; padding:0; list-style:none; text-align:left; }
    .enlines li{ padding:8px 10px; margin:6px 0; border-radius:12px; background:linear-gradient(180deg, #071c2c, #061725); border:1px solid rgba(186,230,253,.2); color:var(--ice-2) }
    .enlines b{ color:var(--ice-3) }

    .controls{ display:flex; gap:2px; flex-wrap:wrap; justify-content:center; margin:0 }
    .btn{ appearance:none; border:none; cursor:pointer; font-weight:900; letter-spacing:.3px; border-radius:12px; padding:10px 14px; color:#072235; background:linear-gradient(90deg, var(--cyan), var(--accent)); box-shadow:0 6px 18px rgba(56,189,248,.35); transition:transform .12s ease, filter .2s ease, box-shadow .2s ease }
    .btn:hover{ filter:brightness(1.08); transform:translateY(-1px); box-shadow:var(--ring) }
    .ghost{ background:transparent; color:var(--ice-2); border:1px solid rgba(186,230,253,.35) }

    .gate, .finish{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(1,7,13,.55); backdrop-filter: blur(6px) saturate(130%); -webkit-backdrop-filter: blur(6px) saturate(130%); z-index:5; }
    .panel{ width:min(520px,92vw); background: linear-gradient(180deg, rgba(10,30,46,.86), rgba(7,22,36,.94)); border:var(--border); border-radius:16px; padding:20px; text-align:center; box-shadow:var(--ring); }
    .panel h2{ margin:0 0 8px; font-size:22px; font-weight:900; color:var(--ice-1) }
    .panel p{ margin:6px 0 14px; color:var(--muted) }

    .flip.animating{ pointer-events:none; }
    @keyframes flyOut{ from{opacity:1; transform:translate3d(0,0,0) scale(1)} to{opacity:0; transform:translate3d(60vw,-6vh,0) rotate(8deg) scale(.96)} }
    @keyframes flyIn{ from{opacity:0; transform:translate3d(-60vw,6vh,0) rotate(-6deg) scale(.96)} to{opacity:1; transform:translate3d(0,0,0) rotate(0) scale(1)} }
    .flip.fly-exit .card{ animation: flyOut .20s cubic-bezier(.2,.7,.2,1) forwards; }
    .flip.fly-enter .card{ animation: flyIn .20s cubic-bezier(.2,.7,.2,1) forwards; }

    #flipToFront{
      background: linear-gradient(90deg, #a78bfa, #60a5fa) !important; color:#07162a !important; border:none !important;
      font-weight:900; letter-spacing:.6px; text-transform:uppercase;
      box-shadow:0 10px 26px rgba(96,165,250,.45), 0 0 26px rgba(167,139,250,.35);
    }
    #flipToFront:hover{ filter:brightness(1.08); box-shadow:0 0 22px rgba(96,165,250,.65), 0 0 34px rgba(167,139,250,.45); }

    #flipToBack{
      position:relative; padding:3px 10px !important; border-radius:16px;
      border:1px solid rgba(255,255,255,.75) !important; border-bottom-color:rgba(10,60,90,.45) !important; border-right-color:rgba(10,60,90,.35) !important;
      background:linear-gradient(180deg, rgba(236,254,255,.98) 0%, rgba(219,234,254,.96) 38%, rgba(56,189,248,.93) 100%) !important;
      color:#062136 !important; text-transform:uppercase; letter-spacing:.8px; font-weight:900;
      box-shadow:0 14px 28px rgba(56,189,248,.35), 0 6px 0 rgba(6,26,43,.65), inset 0 1px 0 rgba(255,255,255,.95), inset 0 -8px 20px rgba(7,34,53,.25);
      transform:translateY(-1px); transition:transform .18s ease, box-shadow .22s ease, filter .22s ease; overflow:hidden; isolation:isolate;
    }
    #flipToBack::before{ content:""; position:absolute; inset:2px 2px 10px 2px; border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,0) 60%); pointer-events:none; mix-blend-mode:screen; }
    #flipToBack::after{
      content:""; position:absolute; inset:-45% -70%;
      background:
        radial-gradient(12px 12px at 22% 32%, rgba(255,255,255,.85), transparent 60%),
        radial-gradient(10px 10px at 72% 65%, rgba(255,255,255,.55), transparent 60%),
        linear-gradient(115deg, rgba(255,255,255,0) 35%, rgba(255,255,255,.45) 50%, rgba(255,255,255,0) 65%);
      transform:translateX(-120%) rotate(8deg); animation:icySweep 2.6s ease-in-out infinite; pointer-events:none; mix-blend-mode:screen;
    }
    #flipToBack:hover{ filter:brightness(1.06); transform:translateY(-3px);
      box-shadow:0 18px 36px rgba(56,189,248,.45), 0 8px 0 rgba(6,26,43,.6), inset 0 1px 0 rgba(255,255,255,1), inset 0 -10px 24px rgba(7,34,53,.28); }
    #flipToBack:active{ transform:translateY(0); box-shadow:0 8px 16px rgba(56,189,248,.35), 0 3px 0 rgba(6,26,43,.7),
      inset 0 1px 0 rgba(255,255,255,.95), inset 0 -6px 16px rgba(7,34,53,.28); }

    .koform{ font-size:1.24rem; font-weight:400; letter-spacing:.3px; color:var(--ice-1); }
    @media (max-width:420px){ .koform{ font-size:1.1rem; } }

    .floating-home { position: fixed; top: 0; right: 0; background: linear-gradient(90deg, var(--cyan), var(--accent)); color: #072235; font-size: 14px; font-weight: 700; text-decoration: none; padding: 8px 16px; border-radius: 0 0 0 10px; box-shadow: 0 6px 18px rgba(56,189,248,.35); z-index: 9999; transition: all 0.25s ease; backdrop-filter: blur(8px) saturate(140%); -webkit-backdrop-filter: blur(8px) saturate(140%); }
    .floating-home:hover{ filter:brightness(1.12); box-shadow: 0 0 12px rgba(56,189,248,.55), 0 0 24px rgba(103,232,249,.45); transform: translateY(-1px); }

    /* ==== Auto image box ==== */
    .img-wrap{ width:min(460px,96%); height:180px; border-radius:12px; overflow:hidden; position:relative; border:1px solid rgba(186,230,253,.2); background:linear-gradient(180deg,#071c2c,#061725); display:flex; align-items:center; justify-content:center; margin-top:6px; }
    .img-wrap.loading::after{ content:""; position:absolute; inset:0; background:linear-gradient(90deg,rgba(255,255,255,0),rgba(255,255,255,.08),rgba(255,255,255,0)); animation:sweep 1.4s infinite; }
    .img-wrap img{ width:100%; height:100%; object-fit:contain; display:block; background:#061725; }
    @keyframes sweep{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

    /* ========== MCQ styles (front) ========== */
    .choices{ width:min(460px,96%); display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:4px; }
    .choice:hover{ transform:translateY(-0.5px); box-shadow: 0 8px 5px rgba(2,12,22,.12); }
    .choice.disabled{ pointer-events:none; opacity:.98; }
    .choice{ position:relative; cursor:pointer; user-select:none; padding:0px 0px 0px 23px; border-radius:0px; background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(245,250,255,.92)); border:1px solid rgba(6,26,43,.12); color:#0c253a; font-weight:700; letter-spacing:0px; box-shadow:0 6px 16px rgba(2,12,22,.08); transition:transform .08s ease, box-shadow .18s ease, filter .2s; }
    .choice .badge{ position:absolute; left:4px; top:50%; transform:translateY(-50%); width:18px; height:18px; border-radius:0px; display:grid; place-items:center; font-weight:900; background:linear-gradient(90deg,#67e8f9,#38bdf8); color:#072235; box-shadow:0 0 12px rgba(56,189,248,.35); font-size:.7rem; line-height:1; }

    .choice.correct{ background:linear-gradient(180deg, rgba(240,253,244,1), rgba(220,252,231,.96)); border-color:rgba(16,185,129,.55); box-shadow:0 0 0 2px rgba(16,185,129,.35), 0 8px 22px rgba(16,185,129,.22); }
    .choice.wrong{ background:linear-gradient(180deg, rgba(254,242,242,1), rgba(254,226,226,.96)); border-color:rgba(239,68,68,.55); box-shadow:0 0 0 2px rgba(239,68,68,.35), 0 8px 22px rgba(239,68,68,.22); }
    .choice.pulse{ animation: mcqPulse 1.2s ease-in-out 1 }
    @keyframes mcqPulse{ 0%{ box-shadow:0 0 0 0 rgba(16,185,129,.45) } 100%{ box-shadow:0 0 0 12px rgba(16,185,129,0) } }

    .hide-choices .choices{ display:none !important; }

    .meta-top{
      position:absolute; top:20px; left:12px; right:12px; bottom:-20px;
      text-align:center; font-weight:800; color:#000; opacity:1;
    }
  </style>
</head>
<body>
  <a href="index.html" class="floating-home">Home</a>

  <header>
    <h1 class="title">VIZKOR Flip Cards</h1>
    <p class="subtitle">Korean Nouns (Categorized)</p>
    <div class="progress" id="progress">&nbsp;</div>
  </header>

  <div class="toolbar">
    <div class="book-tabs" role="tablist" aria-label="Book filter">
      <button class="tab active" data-book="all" type="button">All</button>
      <button class="tab" data-book="1" type="button">Book 1</button>
      <button class="tab" data-book="2" type="button">Book 2</button>
    </div>

    <label for="category-select">Select Noun Category:</label>
    <select id="category-select"></select>

    <div style="display:flex;align-items:center;gap:10px">
      <input type="checkbox" id="togglePics" checked />
      <label for="togglePics">Show picture</label>
    </div>

    <div style="display:flex;align-items:center;gap:10px">
      <input type="checkbox" id="toggleChoices" checked />
      <label for="toggleChoices">Show choices</label>
    </div>
  </div>

  <section class="stage">
    <div class="flip" id="flipWrap" aria-live="polite">
      <div class="card" id="card" tabindex="0" aria-label="Flip card">
        <section class="face front" id="front"></section>
        <section class="face back" id="back"></section>
      </div>
    </div>
  </section>

  <div class="gate" id="gate">
    <div class="panel">
      <h2>Start Practice</h2>
      <p>Enable audio first. Each new card autoplays the base Korean once. Flip to reveal meaning.</p>
      <div class="controls"><button class="btn" id="startBtn">Start (Enable Audio)</button></div>
    </div>
  </div>

  <div class="finish" id="finish" style="display:none">
    <div class="panel">
      <h2>Finished! ðŸŽ‰</h2>
      <p>Na-randomize na lahat. Gusto mo bang ulitin (reshuffle)?</p>
      <div class="controls"><button class="btn" id="restartBtn">Restart (Shuffle)</button></div>
    </div>
  </div>

  <audio id="koAudio" preload="auto"></audio>

  <script src="noun.js"></script>
  <script>
// =================== CONFIG ===================
const USE_AI_GENERATION = true;                 // turn AI images on/off
const AI_ENDPOINT = 'ai-image';            // deploy api/ai-image.js on your host
const AI_TARGET_BYTES = 100 * 1024;             // â‰¤100 KB
const AI_BASE_W = 512, AI_BASE_H = 512;         // base gen size before compression

// =================== GLOBAL STATE ===================
let showPics = document.getElementById('togglePics')?.checked ?? true;
let queue = [];
let current = null;
let index = 0;
let audioReady = false;
let selectedCategory = 'all';
let bookFilter = 'all'; // 'all' | '1' | '2'

const gate = document.getElementById('gate');
const finish = document.getElementById('finish');
const progressEl = document.getElementById('progress');
const flipWrap = document.getElementById('flipWrap');
const cardEl = document.getElementById('card');
const front = document.getElementById('front');
const back  = document.getElementById('back');
const player = document.getElementById('koAudio');
let isAnimating = false;

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function _shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(v=>v[1]); }
function updateProgress(){ if(!queue.length) return; progressEl.textContent = `${Math.min(index+1, queue.length)} / ${queue.length}`; }

// =================== AUDIO (Web Speech fallback) ===================
let speakTimer = 0, koVoice = null;
function stopAllAudio(){ try{ speechSynthesis?.cancel(); }catch(_){} try{ player.pause(); player.currentTime=0; }catch(_){} }
function pickKoVoice(){ const v = speechSynthesis?.getVoices?.() || []; koVoice = v.find(x => (x.lang||'').toLowerCase().startsWith('ko')) || null; }
if('speechSynthesis' in window){ pickKoVoice(); window.speechSynthesis.onvoiceschanged = pickKoVoice; }
function speakWeb(text){
  if(!('speechSynthesis' in window)) return;
  stopAllAudio(); clearTimeout(speakTimer);
  const phrase = String(text||'').trim();
  speakTimer = setTimeout(()=>{
    const u = new SpeechSynthesisUtterance(phrase);
    u.lang='ko-KR'; u.rate=0.95; u.pitch=1.0; if(koVoice) u.voice=koVoice; speechSynthesis.speak(u);
  },180);
}
async function playKo(text){ if(!audioReady){ speakWeb(text); return; } speakWeb(text); }

// =================== IMAGE HELPERS ===================
const IMG_CACHE = new Map();

const HINT_SUFFIXES = {
  pronouns:' (pronoun)', interrogatives:' (question word)', people_relations:' (person)',
  nationality:' (nationality)', food_drinks:' (food or drink)', home_goods:' (household item)',
  places:' (place)', transportation_places:' (transport location)', transportation:' (vehicle)',
  clothing_accessories:' (clothing)', school_office_supplies:' (stationery)', materials:' (material)',
  nature_weather:' (nature)', body_health:' (anatomy)', activities:' (activity)',
  time_numbers:' (time/number)', colors:' (color)', animals:' (animal)',
  emotions_qualities:' (emotion)', technology_modern_life:' (technology)', education_study:' (education)',
  travel_tourism:' (travel)', health_medicine:' (medicine)', banking_finance:' (finance)',
  public_services:' (public service)', events_occasions:' (event)', work_career:' (work)',
  attributes_conditions:' (concept)', daily_life:' (daily life)'
};
const WORD_OVERRIDES = {
  'Kimchi stew':'Kimchi jjigae','Soybean paste stew':'Doenjang jjigae','Cold noodles':'Naengmyeon',
  'knife-cut noodles':'Kalguksu','Fried chicken':'Korean fried chicken','Rice cake':'Tteok',
  'Sweet and sour pork':'Tangsuyuk','Gimbap':'Gimbap','Bibimbap':'Bibimbap','Bulgogi':'Bulgogi',
  'Galbitang':'Galbitang','Galbi':'Galbi','Japchae':'Japchae','Samgyetang':'Samgyetang',
  'Alien Registration Card (ARC)':'Alien registration card','Subway station':'Seoul Metropolitan Subway',
  'KTX':'KTX train','School':'School building','Hospital':'Hospital building'
};
function cleanEnglishLabel(en){ return String(en||'').split('/')[0].replace(/\(.*?\)/g,'').replace(/\s+/g,' ').trim(); }
function englishQueryFor(item){
  let base = cleanEnglishLabel(item.en) || item.ko;
  const hit = Object.keys(WORD_OVERRIDES).find(k => k.toLowerCase() === base.toLowerCase());
  if(hit) base = WORD_OVERRIDES[hit];
  const suffix = HINT_SUFFIXES[selectedCategory] ?? '';
  return (base + suffix).trim();
}
function svgPlaceholder(koText, enText=''){
  const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="800" height="500">
    <rect width="100%" height="100%" fill="#061725"/>
    <text x="50%" y="48%" font-size="64" fill="#dbeafe" font-family="Segoe UI, Arial" font-weight="800" text-anchor="middle">${esc(koText)}</text>
    <text x="50%" y="64%" font-size="28" fill="#bae6fd" font-family="Segoe UI, Arial" text-anchor="middle">${esc(enText)}</text>
  </svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

// ---- AI generation (â‰¤100 KB) ----
function dataUrlByteLength(dataUrl){ const b64 = dataUrl.split(',')[1]||''; return Math.ceil((b64.length*3)/4); }
function loadImageFromDataURL(dataUrl){ return new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=dataUrl; }); }
async function compressToTarget(dataUrl, targetBytes=AI_TARGET_BYTES, maxW=AI_BASE_W, maxH=AI_BASE_H){
  const img = await loadImageFromDataURL(dataUrl);
  let w = img.naturalWidth||img.width, h = img.naturalHeight||img.height;
  const ratio = Math.min(maxW/w, maxH/h, 1); w=Math.max(1,Math.floor(w*ratio)); h=Math.max(1,Math.floor(h*ratio));
  const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
  const ctx = canvas.getContext('2d',{alpha:true}); ctx.clearRect(0,0,w,h); ctx.drawImage(img,0,0,w,h);
  let lo=.35, hi=.92, best=canvas.toDataURL('image/webp', .75);
  if(dataUrlByteLength(best) <= targetBytes) return best;
  for(let i=0;i<7;i++){ const q=(lo+hi)/2; const out=canvas.toDataURL('image/webp', q);
    if(dataUrlByteLength(out)<=targetBytes){ best=out; lo=q; } else { hi=q; } }
  if(dataUrlByteLength(best)>targetBytes && Math.max(w,h)>192){
    const s=.85; return await compressToTarget(best, targetBytes, Math.floor(w*s), Math.floor(h*s));
  }
  return best;
}
function buildCartoonPrompt(q){
  return [
    `flat, 2D cartoon icon of: ${q}`,
    `bold outline, simple shading, minimal or white background`,
    `centered object, no text, no watermark, high contrast`
  ].join(', ');
}
async function callAIEndpoint(prompt){
  const r = await fetch(AI_ENDPOINT, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ prompt, width:AI_BASE_W, height:AI_BASE_H, style:'cartoon' })
  });
  if(!r.ok) throw new Error('AI endpoint failed');
  const j = await r.json(); if(!j?.dataUrl) throw new Error('No dataUrl'); return j.dataUrl;
}
async function getAIImageUrl(q){
  if(IMG_CACHE.has(q)) return IMG_CACHE.get(q);
  const raw = await callAIEndpoint(buildCartoonPrompt(q));
  const small = await compressToTarget(raw, AI_TARGET_BYTES);
  IMG_CACHE.set(q, small); return small;
}

// ---- Network fallback (Wikipedia/Commons/Unsplash) ----
function withTimeout(p, ms=3500){ return Promise.race([p, new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), ms))]); }
async function fetchWikiThumbFrom(lang, q){
  const endpoint = `https://${lang}.wikipedia.org/w/api.php?action=query&origin=*&format=json&prop=pageimages|pageterms&piprop=thumbnail&pithumbsize=640&generator=search&gsrlimit=1&gsrsearch=${encodeURIComponent(q)}`;
  const res = await withTimeout(fetch(endpoint), 3500); if(!res.ok) throw new Error('wiki fail');
  const data = await res.json(); const pages = data?.query?.pages; const first = pages ? Object.values(pages)[0] : null;
  const src = first?.thumbnail?.source; if(src) return src; throw new Error('no thumb');
}
async function fetchCommonsThumb(q){
  const endpoint = `https://commons.wikimedia.org/w/api.php?action=query&origin=*&format=json&generator=search&gsrlimit=1&gsrsearch=${encodeURIComponent(q)}&prop=imageinfo&iiprop=url&iiurlwidth=640`;
  const res = await withTimeout(fetch(endpoint), 3500); if(!res.ok) throw new Error('commons fail');
  const data = await res.json(); const pages = data?.query?.pages; const first = pages ? Object.values(pages)[0] : null;
  const info = first?.imageinfo?.[0]; const src = info?.thumburl || info?.url; if(src) return src; throw new Error('no commons');
}
async function getImageUrlNetwork(q){
  try{ return await fetchWikiThumbFrom('en', q); }catch(_){}
  try{ return await fetchWikiThumbFrom('ko', q); }catch(_){}
  try{ return await fetchCommonsThumb(q); }catch(_){}
  return `https://source.unsplash.com/featured/800x500/?${encodeURIComponent(q)}`;
}

// IMPORTANT: Disable preloading on AI (save credits)
function preloadNext(){
  if (USE_AI_GENERATION) return;
  if (index+1 >= queue.length) return;
  const nxt = queue[index+1]; const q = englishQueryFor(nxt);
  getImageUrlNetwork(q).then(src => { const im=new Image(); im.src=src; }).catch(()=>{});
}

// =================== DATA POOL / CHOICES ===================
function getCurrentPool(){
  const sel = document.getElementById('category-select'); const key = sel?.value || 'all'; selectedCategory = key;
  let pool = [];
  if(key && CATEGORIZED_NOUNS[key]?.data?.length){ pool = CATEGORIZED_NOUNS[key].data; }
  else { pool = CATEGORIZED_NOUNS.all.data; }
  if (bookFilter !== 'all'){ const b = Number(bookFilter); pool = pool.filter(x => Number(x?.book) === b); }
  return pool;
}
function makeChoices(item){
  const pool = getCurrentPool().filter(x => x && (x.en || x.tl || x.ko) && x.ko !== item.ko);
  const cleanEN = s => cleanEnglishLabel(s || '').trim(); const norm = s => cleanEN(s).toLowerCase();
  const correctText = cleanEN(item.en || item.tl || item.ko);
  const used = new Set([norm(correctText)]); const distractors = [];
  for(const x of _shuffle(pool)){
    const txt = cleanEN(x.en || x.tl || x.ko); const key = norm(txt);
    if(!txt || used.has(key)) continue; used.add(key); distractors.push({ text: txt, correct:false }); if(distractors.length >= 3) break;
  }
  const correct = { text: correctText, correct:true };
  return _shuffle([correct, ...distractors]).slice(0,4);
}
function onPickChoice(evt){
  evt.stopPropagation(); const el = evt.currentTarget; const wrap = el.parentElement; const all = [...wrap.querySelectorAll('.choice')];
  all.forEach(c => c.classList.add('disabled')); const isCorrect = el.dataset.correct === 'true';
  if(isCorrect){ el.classList.add('correct','pulse'); }
  else{ el.classList.add('wrong'); const right = all.find(c => c.dataset.correct === 'true'); if(right){ right.classList.add('correct','pulse'); } }
}

// =================== RENDER ===================
async function loadAutoImage(item, wrapSel='#imgWrapFront', imgSel='#autoImgFront'){
  const wrap = document.querySelector(wrapSel); const img = document.querySelector(imgSel);
  if(!wrap || !img) return; if(!showPics){ wrap.style.display='none'; return; }
  wrap.style.display=''; wrap.classList.add('loading'); img.removeAttribute('src'); img.alt='';
  const q = englishQueryFor(item);
  try{
    const src = USE_AI_GENERATION
      ? await getAIImageUrl(q).catch(()=>getImageUrlNetwork(q))
      : await getImageUrlNetwork(q);
    img.onerror = ()=>{ wrap.classList.remove('loading'); img.src = svgPlaceholder(item.ko); };
    img.onload  = ()=>{ wrap.classList.remove('loading'); preloadNext(); };
    img.src = src; img.alt = `${cleanEnglishLabel(item.en)} (${item.ko})`;
  }catch{ wrap.classList.remove('loading'); img.src = svgPlaceholder(item.ko); }
}
function renderFrontWithChoices(item){
  const isChoicesShown = !document.body.classList.contains('hide-choices');
  const imgH = isChoicesShown ? 300 : 240;
  front.innerHTML = `
    <div class="meta meta-top">Page ${item.page} â€¢ Book ${item.book}</div>
    <div class="ko-row">
      <div class="ko" aria-label="Korean">${item.ko}</div>
      <button class="play-base" id="playBaseFront" type="button">ðŸ”Š Play</button>
    </div>
    <div class="img-wrap" id="imgWrapFront" role="img" aria-label="photo area"
         style="height:${imgH}px; display:flex; align-items:center; justify-content:center; margin-bottom:12px;">
      <img id="autoImgFront" alt="${item.ko}" style="max-width:100%; max-height:100%; object-fit:contain;" />
    </div>
    <div class="choices" id="choices"></div>
    <div class="controls" style="margin-top:1px"><button class="btn" id="flipToBack">FLIP the CARD</button></div>
  `;
  front.querySelector('#playBaseFront')?.addEventListener('click', (e)=>{ e.stopPropagation(); playKo(item.ko); });
  front.querySelector('#flipToBack')?.addEventListener('click', (e)=>{ e.stopPropagation(); flipWrap.classList.add('flipped'); });
  loadAutoImage(item, '#imgWrapFront', '#autoImgFront');

  const opts = makeChoices(item); const letters = ['A','B','C','D']; const box = document.getElementById('choices'); box.innerHTML='';
  opts.forEach((opt,i)=>{ const div=document.createElement('div'); div.className='choice'; div.dataset.correct=String(!!opt.correct);
    div.innerHTML = `<span class="badge">${letters[i]}</span>${opt.text}`;
    div.addEventListener('click', onPickChoice, {once:true}); div.addEventListener('click', (e)=>e.stopPropagation()); box.appendChild(div);
  });
}
function renderBack(w){
  back.innerHTML = `
    <div class="ko-big">${w.ko}</div>
    <div class="meta">Page ${w.page} â€¢ Book ${w.book}</div>
    <ul class="enlines">
      <li><b>English:</b> <span class="koform">${w.en}</span></li>
      <li><b>Tagalog:</b> <span class="koform">${w.tl}</span></li>
    </ul>
    <div class="controls" style="margin-top:10px">
      <button class="btn ghost" id="flipToFront">â—€ Back</button>
      <button class="btn" id="nextBtn">Next â–¶</button>
      <button class="btn" id="playBaseBack">ðŸ”Š Base</button>
    </div>`;
  back.querySelector('#nextBtn').onclick = (e)=>{ e.stopPropagation(); nextCardAnimated(); };
  back.querySelector('#playBaseBack').onclick = (e)=>{ e.stopPropagation(); playKo(w.ko); };
  back.querySelector('#flipToFront').onclick = (e)=>{ e.stopPropagation(); flipWrap.classList.remove('flipped'); };
}
function showCard(w){ current = w; renderFrontWithChoices(w); renderBack(w); flipWrap.classList.remove('flipped'); updateProgress(); }
function autoplayCurrentOnce(){ if(!queue.length) return; setTimeout(()=> playKo(queue[index].ko), 220); }

// =================== BUILD/DECK ===================
function buildDeck(){
  const pool = getCurrentPool();
  queue = shuffle([...pool]); index = 0; gate.style.display='none'; finish.style.display='none';
  if (!queue.length){ front.innerHTML='<p>No cards in this selection.</p>'; back.innerHTML=''; return; }
  showCard(queue[index]); if (audioReady) autoplayCurrentOnce();
}

// =================== ANIMATION/NAV ===================
function nextCardAnimated(){
  if(isAnimating) return; isAnimating = true; stopAllAudio(); flipWrap.classList.add('animating','fly-exit');
  const onExitEnd = (e)=>{
    if(e.target !== cardEl) return;
    flipWrap.removeEventListener('animationend', onExitEnd);
    flipWrap.classList.remove('fly-exit'); index++;
    if(index >= queue.length){ flipWrap.classList.remove('animating'); isAnimating=false; finish.style.display='flex'; return; }
    showCard(queue[index]); flipWrap.classList.add('fly-enter');
    const onEnterEnd = (ev)=>{
      if(ev.target !== cardEl) return;
      flipWrap.removeEventListener('animationend', onEnterEnd);
      flipWrap.classList.remove('fly-enter','animating'); isAnimating=false; if(audioReady) autoplayCurrentOnce();
    };
    flipWrap.addEventListener('animationend', onEnterEnd);
  };
  flipWrap.addEventListener('animationend', onExitEnd);
}
flipWrap.addEventListener('click', ()=>{ if(!queue.length || isAnimating) return; if(!flipWrap.classList.contains('flipped')) flipWrap.classList.add('flipped'); else nextCardAnimated(); });
cardEl.addEventListener('keydown', (e)=>{
  if(e.code==='Enter' || e.code==='Space'){ e.preventDefault(); if(!flipWrap.classList.contains('flipped')) flipWrap.classList.add('flipped'); else nextCardAnimated(); }
  if(e.code==='ArrowRight'){ e.preventDefault(); nextCardAnimated(); }
  if(e.code==='ArrowLeft'){ e.preventDefault(); flipWrap.classList.remove('flipped'); }
});

// =================== CATEGORY POPULATION (respects Book filter) ===================
function populateCategoriesByBook(){
  const sel = document.getElementById('category-select'); if (!sel) return;
  const prev = sel.value; sel.innerHTML='';
  const optAll = document.createElement('option'); optAll.value='all';
  optAll.textContent = (CATEGORIZED_NOUNS.all?.name?.en) || 'All'; sel.appendChild(optAll);
  for (const key in CATEGORIZED_NOUNS){
    if(key === 'all') continue;
    const arr = CATEGORIZED_NOUNS[key]?.data || [];
    const showThis = arr.some(w => bookFilter === 'all' ? true : Number(w?.book) === Number(bookFilter));
    if(showThis){ const opt=document.createElement('option'); opt.value=key; opt.textContent=CATEGORIZED_NOUNS[key].name?.en || key; sel.appendChild(opt); }
  }
  if ([...sel.options].some(o=>o.value===prev)) sel.value = prev; else sel.value = 'all';
}
(function init(){
  populateCategoriesByBook();
  document.getElementById('category-select').addEventListener('change', buildDeck);
  document.querySelectorAll('.book-tabs .tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.book-tabs .tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      bookFilter = btn.dataset.book;
      populateCategoriesByBook();
      buildDeck();
    });
  });
})();
document.getElementById('startBtn').onclick = ()=>{ audioReady = true; gate.style.display='none'; try{ speechSynthesis?.cancel(); }catch(_){} buildDeck(); };
document.getElementById('restartBtn').onclick = ()=>{ finish.style.display='none'; buildDeck(); };

const picsToggle = document.getElementById('togglePics');
if(picsToggle){ picsToggle.addEventListener('change', (e)=>{ showPics = e.target.checked; if(queue.length){ showCard(queue[index]); } }); }
document.addEventListener('click', (e)=>{ if(e.target && e.target.id === 'flipToFront'){ flipWrap?.classList.remove('flipped'); } });

const toggleChoices = document.getElementById('toggleChoices');
const CHOICES_KEY = 'vizkor_show_choices';
const savedChoices = localStorage.getItem(CHOICES_KEY);
const shouldShow = savedChoices === null ? true : savedChoices === 'true';
document.body.classList.toggle('hide-choices', !shouldShow); toggleChoices.checked = shouldShow;
toggleChoices.addEventListener('change', (e)=>{
  const on = e.target.checked;
  document.body.classList.toggle('hide-choices', !on);
  localStorage.setItem(CHOICES_KEY, String(on));
  if(queue.length){ showCard(queue[index]); }
});
  </script>
  <!-- (Optional) Disable context actions -->
  <!--
  <script>
  document.addEventListener("contextmenu", e=>e.preventDefault(), false);
  document.addEventListener("selectstart", e=>e.preventDefault(), false);
  document.addEventListener("dragstart", e=>e.preventDefault(), false);
  document.addEventListener("keydown", function(e){
    if (e.key === "F12" || (e.ctrlKey && ["u","s","c","x","v"].includes(e.key.toLowerCase()))) { e.preventDefault(); }
  }, false);
  </script>
  -->
</body>
</html>
