<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VIZKOR Numbers Trainer – Native, Sino, Time (Analog) + Counters & Y/M/D</title>
  <style>
    :root{
      --bg-1:#03121f; --bg-2:#0a1e2e;
      --ice-1:#ecfeff; --ice-2:#dbeafe; --ice-3:#bae6fd;
      --text:#eef6ff; --muted:#a9c3d9;
      --accent:#38bdf8; --accent-2:#0ea5e9;
      --cyan:#67e8f9; --cyan-2:#22d3ee; --navy:#0b2440;
      --ring:0 0 18px rgba(56,189,248,.55), 0 0 32px rgba(103,232,249,.35);
      --border:1px solid rgba(103,232,249,.30);
      --shadow:0 14px 38px rgba(0,0,0,.55);
      --sa-bottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif; color:var(--text);
      min-height:100dvh; display:flex; flex-direction:column; align-items:center; gap:10px;
      background:
        radial-gradient(1200px 800px at 5% -10%, rgba(56,189,248,.18), transparent 60%),
        radial-gradient(1200px 800px at 120% 110%, rgba(103,232,249,.16), transparent 60%),
        linear-gradient(180deg, var(--bg-1), #061a2b 65%, #04121e);
      position:relative; isolation:isolate; padding:12px 10px calc(52px + var(--sa-bottom));
    }
    body::before{ content:""; position:fixed; inset:-20%; background: conic-gradient(from 200deg at 60% 40%, rgba(186,230,253,.12), rgba(34,211,238,.10), rgba(56,189,248,.14), rgba(186,230,253,.10), rgba(34,211,238,.10)); filter:blur(48px); animation: drift 20s linear infinite; z-index:-1; opacity:.9; }
    @keyframes drift{0%{transform:translate3d(0,0,0) rotate(0) scale(1)}50%{transform:translate3d(-3%,1%,0) rotate(10deg) scale(1.05)}100%{transform:translate3d(0,0,0) rotate(0) scale(1)}}

    header{text-align:center}
    .title{ margin:0; font-size:clamp(1rem,2.8vw,1.35rem); font-weight:900; letter-spacing:1.2px; text-transform:uppercase; background:linear-gradient(180deg, var(--ice-1), var(--ice-2) 55%, var(--ice-3)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-shadow:0 0 10px rgba(255,255,255,.6),0 0 18px rgba(56,189,248,.35); }
    .subtitle{ margin:2px 0 0; color:var(--muted); font-weight:600; font-size:clamp(.7rem,2.4vw,.85rem) }
    .progress{ margin-top:4px; font-weight:800; color:var(--ice-2); font-size:.85rem }

    /* --- Toolbar (collapsible on mobile) --- */
    details.toolbar{ width:min(500px,96vw); margin-top:6px; background:linear-gradient(180deg,#0b2438,#081c2d); border:var(--border); box-shadow:var(--ring); border-radius:14px; overflow:hidden }
    details.toolbar>summary{ list-style:none; cursor:pointer; padding:8px 10px; font-weight:900; color:var(--ice-1); display:flex; align-items:center; justify-content:center; gap:8px; user-select:none; font-size:.95rem }
    details.toolbar[open]>summary{ border-bottom:1px solid rgba(186,230,253,.16) }
    details.toolbar .panel{ padding:8px }
    .toolrow{ display:flex; flex-wrap:wrap; gap:6px 8px; align-items:center; justify-content:center; }
    .label{ color:var(--ice-2); font-weight:800; letter-spacing:.3px; font-size:.8rem }
    .select{ background:#061725; color:var(--ice-2); border:1px solid rgba(186,230,253,.3); border-radius:10px; padding:6px 8px; font-weight:800; font-size:.85rem }

    .seg{ display:inline-flex; background:rgba(186,230,253,.08); border:1px solid rgba(186,230,253,.24); border-radius:10px; padding:3px; }
    .seg input{ display:none }
    .seg label{ cursor:pointer; padding:5px 8px; border-radius:8px; font-weight:800; color:var(--ice-2); user-select:none; font-size:.8rem }
    .seg input:checked + label{ background:linear-gradient(90deg, var(--cyan), var(--accent)); color:#072235; box-shadow:0 4px 14px rgba(56,189,248,.3) }

    /* --- Card Stage (SMALLER) --- */
    .stage{ width:min(420px, 92vw); height:clamp(240px, 44dvh, 360px); display:flex; align-items:center; justify-content:center; margin-top:6px; }
    .flip{ perspective:1200px; width:100%; height:100%; }
    .card{ position:relative; width:100%; height:100%; transform-style:preserve-3d; transition: transform .7s cubic-bezier(.2,.7,.2,1); }
    .flipped .card{ transform:rotateY(180deg); }

    .face{ position:absolute; inset:0; border-radius:14px; backface-visibility:hidden; overflow:hidden; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; text-align:center; padding:8px; }
    .front{ color:#0c253a; background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.88)); border:1px solid rgba(255,255,255,.6); box-shadow:0 8px 22px rgba(2,12,22,.38); }
    .back{ transform:rotateY(180deg); background: linear-gradient(180deg, rgba(10,30,46,.86), rgba(7,22,36,.94)); border:var(--border); box-shadow:var(--ring); }

    .big-num{ font-size:clamp(1rem, 4.6vw, 1.4rem); font-weight:900; letter-spacing:.5px; color:#0c253a }
    .big-num-hero{ font-size:clamp(1.3rem, 6.4vw, 2rem); font-weight:1000; letter-spacing:.4px; line-height:1.05; background:linear-gradient(90deg, #ffffff, var(--ice-3)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-shadow:0 0 18px rgba(56,189,248,.45), 0 0 6px rgba(186,230,253,.38); }
    .ko-big{ font-size:clamp(1rem, 4.8vw, 1.4rem); line-height:1.15; width:100%; margin:0; font-weight:900; letter-spacing:.4px; }

    .ko-row{ display:flex; align-items:center; justify-content:center; gap:8px; width:min(400px,96%); flex-wrap:wrap }
    .play-base{ appearance:none; border:none; cursor:pointer; border-radius:10px; padding:7px 9px; font-weight:900; color:#072235; background:linear-gradient(90deg, var(--cyan), var(--accent)); box-shadow:0 4px 14px rgba(56,189,248,.28); font-size:.9rem; min-height:34px }

    .enlines{ width:min(400px,96%); margin:4px auto 0; padding:0; list-style:none; text-align:left; }
    .enlines li{ padding:6px 8px; margin:4px 0; border-radius:10px; background:linear-gradient(180deg, #071c2c, #061725); border:1px solid rgba(186,230,253,.2); color:var(--ice-2); font-size:.95rem }

    .gloss{ width:min(400px,96%); margin-top:4px; display:grid; grid-template-columns: repeat(auto-fit, minmax(78px,1fr)); gap:6px; justify-content:center }
    .gchunk{ background:linear-gradient(180deg,#0b2438,#081c2d); border:1px solid rgba(186,230,253,.2); border-radius:10px; padding:6px 8px; min-width:76px }
    .gko{ display:block; font-weight:900; color:var(--ice-1); text-align:center; font-size:.95rem }
    .gen{ display:block; font-size:.9rem; color:var(--ice-3); opacity:.95; text-align:center }

    .controls{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin:0 }
    .btn{ appearance:none; border:none; cursor:pointer; font-weight:900; letter-spacing:.3px; border-radius:10px; padding:8px 10px; color:#072235; background:linear-gradient(90deg, var(--cyan), var(--accent)); box-shadow:0 4px 14px rgba(56,189,248,.28); transition:transform .12s ease, filter .2s ease, box-shadow .2s ease; font-size:.9rem; min-height:34px }
    .btn:hover{ filter:brightness(1.08); transform:translateY(-1px); box-shadow:var(--ring) }
    .ghost{ background:transparent; color:var(--ice-2); border:1px solid rgba(186,230,253,.32) }

    /* AM/PM badge */
    .ampm{ display:inline-flex; align-items:center; gap:6px; padding:3px 7px; border-radius:888px; font-weight:900; font-size:.85rem; color:#072235; background:linear-gradient(90deg, var(--cyan), var(--accent)); box-shadow:0 4px 14px rgba(56,189,248,.3) }

    /* Sticky bottom mobile bar */
    .mbar{ position:fixed; left:8px; right:8px; bottom:8px; padding-bottom:var(--sa-bottom); border-radius:12px; background:linear-gradient(180deg, #0b2236cc, #081a2dcc); border:1px solid rgba(186,230,253,.24); box-shadow:0 10px 26px rgba(2,12,22,.55); display:flex; gap:6px; justify-content:space-between; align-items:center; padding:6px; backdrop-filter: blur(8px) saturate(140%); -webkit-backdrop-filter: blur(8px) saturate(140%); }
    .mbar .mbtn{ flex:1; min-width:0; border:none; border-radius:9px; padding:8px 10px; font-weight:900; letter-spacing:.3px; color:#072235; background:linear-gradient(90deg, var(--cyan), var(--accent)); box-shadow:0 4px 14px rgba(56,189,248,.28); font-size:.9rem }

    @media (min-width: 680px){
      .mbar{ display:none }
      body{ padding-bottom:5px }
      .stage{ height:clamp(290px, 30dvh, 290px) }
    }

    /* Transitions */
    .flip.animating{ pointer-events:none; }
    @keyframes flyOut{ from{opacity:1; transform:translate3d(0,0,0) scale(1)} to{opacity:0; transform:translate3d(60vw,-6vh,0) rotate(8deg) scale(.96)} }
    @keyframes flyIn{ from{opacity:0; transform:translate3d(-60vw,6vh,0) rotate(-6deg) scale(.96)} to{opacity:1; transform:translate3d(0,0,0) rotate(0) scale(1)} }
    .flip.fly-exit .card{ animation: flyOut .55s cubic-bezier(.2,.7,.2,1) forwards; }
    .flip.fly-enter .card{ animation: flyIn .55s cubic-bezier(.2,.7,.2,1) forwards; }
    .flip{ transform:scale(.9); transform-origin:center; }
    @media (max-width:480px){ .flip{ transform:scale(.85); } }

    .floating-home{ position: fixed; top: 0; right: 0; background: linear-gradient(90deg, var(--cyan), var(--accent)); color: #072235; font-size: 12px; font-weight: 700; text-decoration: none; padding: 6px 10px; border-radius: 0 0 0 10px; box-shadow: 0 6px 18px rgba(56,189,248,.35); z-index: 9999; transition: all 0.25s ease; backdrop-filter: blur(8px) saturate(140%); -webkit-backdrop-filter: blur(8px) saturate(140%); }
    .floating-home:hover{ filter:brightness(1.12); box-shadow: 0 0 12px rgba(56,189,248,.55), 0 0 24px rgba(103,232,249,.45); transform: translateY(-1px); }

    /* ===== Choices (4 boxes) – compressed ===== */
    .quiz{ width:min(420px,94vw); margin:4px auto 0; }
    .quiz .toggleRow{ display:flex; align-items:center; justify-content:center; gap:8px; color:var(--ice-2); margin:2px 0 4px; font-size:.9rem; }
    .choicesGrid{ display:grid; grid-template-columns:repeat(2, minmax(110px,1fr)); gap:8px; width:min(400px,96%); margin:6px auto 0; }
    .choiceBtn{ appearance:none; border:1px solid rgba(186,230,253,.32); background:linear-gradient(180deg,#071c2c,#061725); color:var(--ice-1); font-weight:800; padding:8px 10px; border-radius:10px; cursor:pointer; text-align:center; min-height:34px; box-shadow:0 4px 14px rgba(56,189,248,.20); transition:filter .18s ease, transform .12s ease, box-shadow .18s ease; user-select:none; font-size:.9rem; }
    .choiceBtn:hover{ filter:brightness(1.08); transform:translateY(-1px) }
    .choiceBtn.correct{ border-color:rgba(56,189,248,.8); box-shadow:0 0 0 2px rgba(56,189,248,.55), 0 0 18px rgba(56,189,248,.4); background:linear-gradient(180deg,#0b2a42,#08314e); }
    @keyframes shakeX{ 0%,100%{transform:translateX(0)} 20%{transform:translateX(-7px)} 40%{transform:translateX(7px)} 60%{transform:translateX(-5px)} 80%{transform:translateX(5px)} }
    .choiceBtn.wrong{ background:linear-gradient(180deg,#2b0a0a,#1a0707); border-color:rgba(255,99,132,.65); animation:shakeX .35s ease; }
    .choiceBtn.reveal{ border-color:rgba(56,189,248,.9); box-shadow:0 0 0 3px rgba(56,189,248,.8), 0 0 24px rgba(56,189,248,.55); background:linear-gradient(180deg,#0b2a42,#08314e); }

    /* ===== Minimal modal (kept for future) ===== */
    .modalBack{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(3,13,22,.66); backdrop-filter: blur(6px) saturate(140%); -webkit-backdrop-filter: blur(6px) saturate(140%); z-index:10000; }
    .modal{ width:min(320px,90vw); background:linear-gradient(180deg,#0b2438,#081c2d); border:1px solid rgba(186,230,253,.24); border-radius:12px; box-shadow:var(--ring); padding:12px 14px; text-align:center; }
    .modal h3{ margin:0 0 6px; font-size:1rem; color:var(--ice-1) }
    .modal p{ margin:6px 0 10px; color:var(--ice-2); font-weight:800 }
    .modal .btn{ padding:8px 10px; font-size:.9rem }
  </style>
</head>
<body>
  <a href="index.html" class="floating-home">Home</a>

  <header>
    <h1 class="title">VIZKOR Numbers Trainer</h1>
    <p class="subtitle">Native (0–99) • Sino (1–9 digits) • Time (Analog) • <b>Counters</b> • <b>Date (Y/M/D)</b></p>
    <div class="progress" id="progress">&nbsp;</div>
  </header>

  <!-- Collapsible toolbar -->
  <details class="toolbar" id="toolbar" open>
    <summary>Set⚙️</summary>
    <div class="panel">
      <div class="toolrow">
        <span class="label">Mode:</span>
        <select id="modeSelect" class="select" aria-label="Mode">
          <option value="native" selected>Native(99)</option>
          <option value="sino">Sino(9digits)</option>
          <option value="time">Time(Analog)</option>
          <option value="count">Counting Units</option>
          <option value="date">Date (Y/M/D)</option>
        </select>

        <span class="label" id="frontNumWrapLabel"></span>
        <label style="display:inline-flex; align-items:center; gap:8px;">
          <input type="checkbox" id="showNumber">
          <span class="label" style="margin:0">Show</span>
        </label>
      </div>

      <div class="toolrow" id="sinoOptions" style="display:none">
        <span class="label">Sino:</span>
        <div class="seg" role="radiogroup" aria-label="Digit count (Sino)">
          <input type="radio" name="digits" id="dg1" value="1" checked><label for="dg1">1</label>
          <input type="radio" name="digits" id="dg2" value="2"><label for="dg2">2</label>
          <input type="radio" name="digits" id="dg3" value="3"><label for="dg3">3</label>
          <input type="radio" name="digits" id="dg4" value="4"><label for="dg4">4</label>
          <input type="radio" name="digits" id="dg5" value="5"><label for="dg5">5</label>
          <input type="radio" name="digits" id="dg6" value="6"><label for="dg6">6</label>
          <input type="radio" name="digits" id="dg7" value="7"><label for="dg7">7</label>
          <input type="radio" name="digits" id="dg8" value="8"><label for="dg8">8</label>
          <input type="radio" name="digits" id="dg9" value="9"><label for="dg9">9</label>
        </div>
      </div>

      <!-- Counting Units -->
      <div class="toolrow" id="countOptions" style="display:none">
        <span class="label">Counter:</span>
        <select id="unitSelect" class="select" aria-label="Counter Unit">
          <option value="random" selected>Random (mix)</option>
          <optgroup label="Native-based">
            <option value="gae">개 — items</option>
            <option value="myeong">명 — people</option>
            <option value="saram">사람 — people (casual)</option>
            <option value="sal">살 — years old</option>
            <option value="byeong">병 — bottles</option>
            <option value="mari">마리 — animals</option>
            <option value="gwon">권 — books</option>
            <option value="dae">대 — vehicles</option>
            <option value="beon">번 — times</option>
            <option value="sigan">시간 — hours (duration)</option>
          </optgroup>
          <optgroup label="Sino-based">
            <option value="bun">분 — minutes</option>
            <option value="won">원 — won (₩)</option>
            <option value="cheung">층 — floor</option>
            <option value="gwa">과 — lessons</option>
            <option value="ju">주 — weeks</option>
            <option value="gaeweol">개월 — months (duration)</option>
          </optgroup>
        </select>
      </div>

      <!-- Date (Y/M/D) -->
      <div class="toolrow" id="dateOptions" style="display:none">
        <span class="label">Year:</span>
        <select id="yearSelect" class="select" aria-label="Year"></select>
        <span class="label">Month:</span>
        <select id="monthSelect" class="select" aria-label="Month"></select>
        <span class="label">Day:</span>
        <select id="daySelect" class="select" aria-label="Day"></select>
        <button class="btn" id="applyDateBtn" type="button">Use</button>
        <button class="btn ghost" id="randDateBtn" type="button">Random</button>
      </div>
    </div>
  </details>

  <section class="stage">
    <div class="flip" id="flipWrap" aria-live="polite">
      <div class="card" id="card" tabindex="0" aria-label="Flip card">
        <section class="face front" id="front"></section>
        <section class="face back" id="back"></section>
      </div>
    </div>
  </section>

  <!-- Choices UI -->
  <section class="quiz" id="quiz">
    <div class="toggleRow">
      <input type="checkbox" id="toggleChoices" checked />
      <label for="toggleChoices">Show choices (4 options)</label>
    </div>
    <div id="choicesGrid" class="choicesGrid" role="group" aria-label="Choices"></div>
  </section>

  <div class="finish" id="finish" style="display:none">
    <div class="panel" style="text-align:center;padding:12px 14px">
      <h2 style="margin:0 0 6px;color:var(--ice-1);font-size:1.05rem">Finished! 🎉</h2>
      <div class="controls"><button class="btn" id="restartBtn">Restart (Shuffle)</button></div>
    </div>
  </div>

  <!-- Mobile sticky action bar -->
  <div class="mbar" id="mbar">
    <button class="mbtn" id="mFlip">Flip</button>
    <button class="mbtn" id="mPlay">Play</button>
    <button class="mbtn" id="mNext">Next ▶</button>
  </div>

  <audio id="koAudio" preload="auto"></audio>

  <script>
/* =================== AUDIO =================== */
const VOICERSS_KEY = "YOUR_VOICERSS_KEY_HERE"; // leave as-is to use browser TTS
const audioCache = new Map();
const player = document.getElementById('koAudio');
const koTtsUrl = (text)=>`https://api.voicerss.org/?key=${VOICERSS_KEY}&hl=ko-kr&c=MP3&f=48khz_16bit_mono&src=${encodeURIComponent(text)}`;
let audioReady = true;
function speakWeb(text){ if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(text); u.lang='ko-KR'; u.rate=0.95; try{speechSynthesis.cancel();}catch(e){} speechSynthesis.speak(u); }
async function playKo(text){ if(!audioReady) return; if(!VOICERSS_KEY || VOICERSS_KEY==="YOUR_VOICERSS_KEY_HERE"){ speakWeb(text); return; } let url=audioCache.get(text); if(!url){ url=koTtsUrl(text); audioCache.set(text,url); } player.src=url; try{ await player.play(); }catch(e){ speakWeb(text); } }

/* =================== DATA: NATIVE & SINO =================== */
const N_UNITS=['영','하나','둘','셋','넷','다섯','여섯','일곱','여덟','아홉'];
const N_TENS=['','열','스물','서른','마흔','쉰','예순','일흔','여든','아흔'];
const N_UNITS_RR=['yeong','hana','dul','set','net','daseot','yeoseot','ilgop','yeodeol','ahop'];
const N_TENS_RR=['','yeol','seumul','seoreun','maheun','swin','yesun','ilheun','yeodeun','aheun'];
function toNative(n){ if(n===0) return '영'; if(n<10) return N_UNITS[n]; const t=Math.floor(n/10), u=n%10; return N_TENS[t]+(u?N_UNITS[u]:''); }
function romanizeNative(n){ if(n===0) return 'yeong'; if(n<10) return N_UNITS_RR[n]; const t=Math.floor(n/10), u=n%10; return N_TENS_RR[t]+(u?(' '+N_UNITS_RR[u]):''); }
function breakdownNative(n){ if(n===0) return [{ko:'영',num:0}]; const a=[]; if(n>=10){const t=Math.floor(n/10); a.push({ko:N_TENS[t],num:t*10});} if(n%10){const u=n%10; a.push({ko:N_UNITS[u],num:u});} return a.length?a:[{ko:'영',num:0}]; }

const MAX_SINO=9999999999;
const S_DIG=['','일','이','삼','사','오','육','칠','팔','구'];
const S_DIG_R=['','il','i','sam','sa','o','yuk','chil','pal','gu'];
const S_UNIT_SMALL=['','십','백','천'];
function under10000(n){ let s=''; const d=String(n).padStart(4,'0').split('').map(x=>+x); for(let i=0;i<4;i++){ const di=d[i]; if(!di) continue; const pos=3-i; if(pos>0){ s+=(di===1?'':S_DIG[di])+S_UNIT_SMALL[pos]; }else{ s+=S_DIG[di]; } } return s||'영'; }
function toSino(n){
  if(n===0) return '영';
  const eok=Math.floor(n/1e8), r1=n%1e8, man=Math.floor(r1/1e4), rest=r1%1e4, parts=[];
  if(eok){ const p=under10000(eok); parts.push((p==='일'||p==='영'||p==='')?'억':p+'억'); }
  if(man){ const p=under10000(man); parts.push((p==='일'||p==='영'||p==='')?'만':p+'만'); }
  if(rest){ parts.push(under10000(rest)); }
  return parts.join(' ').trim();
}
function tokensUnder10000(n){ const tks=[], d=String(n).padStart(4,'0').split('').map(x=>+x), names=['천','백','십','']; for(let i=0;i<4;i++){const di=d[i]; if(!di) continue; const name=names[i]; tks.push(name?((di===1?'':S_DIG[di])+name):S_DIG[di]); } return tks.length?tks:['영']; }
function breakdownSino(n){
  if(n===0) return [{ko:'영',num:0}];
  const arr=[], eok=Math.floor(n/1e8), r1=n%1e8, man=Math.floor(r1/1e4), rest=r1%1e4;
  function add(x,base){ for(const t of tokensUnder10000(x)){ let num=0; if(t.endsWith('천')){ const d=t.length===1?1:S_DIG.indexOf(t.replace('천','')); num=d*1000; } else if(t.endsWith('백')){ const d=t.length===1?1:S_DIG.indexOf(t.replace('백','')); num=d*100; } else if(t.endsWith('십')){ const d=t.length===1?1:S_DIG.indexOf(t.replace('십','')); num=d*10; } else if(t==='영'){ num=0; } else { num=S_DIG.indexOf(t); } arr.push({ko:t,num:num*base}); } }
  if(eok) add(eok,1e8); if(man) add(man,1e4); if(rest) add(rest,1); return arr;
}
function romanizeTokenSino(tok){ if(tok==='억') return 'eok'; if(tok==='만') return 'man';
  if(tok.endsWith('천')){ const d=tok.replace('천',''); const r=d?S_DIG_R[S_DIG.indexOf(d)]+' ':''; return r+'cheon'; }
  if(tok.endsWith('백')){ const d=tok.replace('백',''); const r=d?S_DIG_R[S_DIG.indexOf(d)]+' ':''; return r+'baek'; }
  if(tok.endsWith('십')){ const d=tok.replace('십',''); const r=d?S_DIG_R[S_DIG.indexOf(d)]+' ':''; return r+'sip'; }
  if(tok==='영') return 'yeong'; return S_DIG_R[S_DIG.indexOf(tok)]||'';
}
function romanizeSino(n){
  if(n===0) return 'yeong';
  const eok=Math.floor(n/1e8), r1=n%1e8, man=Math.floor(r1/1e4), rest=r1%1e4, parts=[];
  if(eok){ const t=tokensUnder10000(eok).map(romanizeTokenSino).join(' '); parts.push((t?t+' ':'')+'eok'); }
  if(man){ const t=tokensUnder10000(man).map(romanizeTokenSino).join(' '); parts.push((t?t+' ':'')+'man'); }
  if(rest){ parts.push(tokensUnder10000(rest).map(romanizeTokenSino).join(' ')); }
  return parts.join(' ').split(' ').filter(Boolean).join(' ');
}

/* ===== Year (special reading: no 만/억) ===== */
function toSinoYear(y){ return under10000(y); }
function romanizeYear(y){ return tokensUnder10000(y).map(romanizeTokenSino).join(' '); }

/* =================== TIME (ANALOG) =================== */
const HOUR_NATIVE_FORMS=['','한','두','세','네','다섯','여섯','일곱','여덟','아홉','열','열한','열두'];
const HOUR_NATIVE_ROMA=['','han','du','se','ne','daseot','yeoseot','ilgop','yeodeol','ahop','yeol','yeolhan','yeoldu'];
function timeToKo(h24,m){ const am=h24<12, h12=((h24%12)||12); const hourKo=HOUR_NATIVE_FORMS[h12]+' 시'; return (am?'오전 ':'오후 ')+hourKo+' '+(m===0?'정각':toSino(m)+' 분'); }
function timeToRR(h24,m){ const am=h24<12, h12=((h24%12)||12); const hourR=HOUR_NATIVE_ROMA[h12]+' si'; const minR=m===0?'jeonggak':romanizeSino(m)+' bun'; return (am?'ojeon ':'ohu ')+hourR+' '+minR; }
function pad2(n){ return String(n).padStart(2,'0'); }
function formatTime12(h24,m){ const am=h24<12, h12=((h24%12)||12); return `${pad2(h12)}:${pad2(m)} ${am?'AM':'PM'}`; }
function drawClock(canvas,h24,m){
  const ctx=canvas.getContext('2d'), DPR=window.devicePixelRatio||1, size=Math.min(canvas.clientWidth||canvas.width, canvas.clientHeight||canvas.height);
  const W=size*DPR; canvas.width=W; canvas.height=W; const cx=W/2, cy=W/2, R=W*0.45;
  ctx.clearRect(0,0,W,W);
  ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,0.94)'; ctx.fill(); ctx.lineWidth=4*DPR; ctx.strokeStyle='rgba(56,189,248,0.55)'; ctx.stroke();
  for(let i=0;i<60;i++){ const ang=(Math.PI*2)*(i/60)-Math.PI/2; const r1=R*(i%5===0?0.82:0.88), r2=R*0.96;
    ctx.beginPath(); ctx.moveTo(cx+Math.cos(ang)*r1, cy+Math.sin(ang)*r1); ctx.lineTo(cx+Math.cos(ang)*r2, cy+Math.sin(ang)*r2);
    ctx.lineWidth=(i%5===0?3:1.5)*DPR; ctx.strokeStyle='rgba(10,30,46,0.9)'; ctx.stroke(); }
  ctx.fillStyle='rgba(10,30,46,0.85)'; ctx.font=`${14*DPR}px system-ui,-apple-system,Segoe UI,Arial`; ctx.textAlign='center'; ctx.textBaseline='middle';
  [[12,0],[3,90],[6,180],[9,270]].forEach(([num,deg])=>{ const ang=(deg-90)*Math.PI/180, rr=R*0.7; ctx.fillText(String(num), cx+Math.cos(ang)*rr, cy+Math.sin(ang)*rr); });
  const h12=((h24%12)||12), hourAng=(Math.PI*2)*((h12%12)/12 + m/720)-Math.PI/2, minAng=(Math.PI*2)*(m/60)-Math.PI/2;
  ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+Math.cos(hourAng)*R*0.55, cy+Math.sin(hourAng)*R*0.55); ctx.lineWidth=5*DPR; ctx.strokeStyle='rgba(34,211,238,0.9)'; ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+Math.cos(minAng)*R*0.78, cy+Math.sin(minAng)*R*0.78); ctx.lineWidth=4*DPR; ctx.strokeStyle='rgba(56,189,248,0.95)'; ctx.stroke();
  ctx.beginPath(); ctx.arc(cx,cy,5*DPR,0,Math.PI*2); ctx.fillStyle='rgba(10,30,46,0.95)'; ctx.fill();
}

/* =================== COUNTERS =================== */
const COUNTERS=[
  {key:'gae', ko:'개', rr:'gae', en:'items (generic)', system:'native', range:[1,99]},
  {key:'myeong', ko:'명', rr:'myeong', en:'people', system:'native', range:[1,50]},
  {key:'saram', ko:'사람', rr:'saram', en:'people (casual)', system:'native', range:[1,50]},
  {key:'sal', ko:'살', rr:'sal', en:'years old', system:'native', range:[1,99]},
  {key:'byeong', ko:'병', rr:'byeong', en:'bottles', system:'native', range:[1,60]},
  {key:'mari', ko:'마리', rr:'mari', en:'animals', system:'native', range:[1,60]},
  {key:'gwon', ko:'권', rr:'gwon', en:'books', system:'native', range:[1,60]},
  {key:'dae', ko:'대', rr:'dae', en:'vehicles', system:'native', range:[1,60]},
  {key:'beon', ko:'번', rr:'beon', en:'times (occurrences)', system:'native', range:[1,99]},
  {key:'sigan', ko:'시간', rr:'sigan', en:'hours (duration)', system:'native', range:[1,24]},
  {key:'bun', ko:'분', rr:'bun', en:'minutes', system:'sino', range:[1,59]},
  {key:'won', ko:'원', rr:'won', en:'won (₩)', system:'sino', range:[1,9999]},
  {key:'cheung', ko:'층', rr:'cheung', en:'floor (storey)', system:'sino', range:[1,70]},
  {key:'gwa', ko:'과', rr:'gwa', en:'lessons/chapters', system:'sino', range:[1,50]},
  {key:'ju', ko:'주', rr:'ju', en:'weeks', system:'sino', range:[1,52]},
  {key:'gaeweol', ko:'개월', rr:'gae-wol', en:'months (duration)', system:'sino', range:[1,36]},
];
function getUnitByKey(k){ return COUNTERS.find(c=>c.key===k) || COUNTERS[0]; }
function nativeCountForm(n){
  if(n===0) return '영';
  const t=Math.floor(n/10), u=n%10;
  let tens = t? N_TENS[t] : '';
  // 20 exact uses 스무
  if(t===2 && u===0) tens='스무';
  let unit='';
  if(u===0){ unit=''; }
  else if(u===1){ unit='한'; }
  else if(u===2){ unit='두'; }
  else if(u===3){ unit='세'; }
  else if(u===4){ unit='네'; }
  else { unit=N_UNITS[u]; }
  return (tens+unit) || '영';
}
function romanizeNativeCount(n){
  if(n===0) return 'yeong';
  const t=Math.floor(n/10), u=n%10;
  let tens = t? N_TENS_RR[t] : '';
  if(t===2 && u===0) tens='seumu';
  let unit='';
  if(u===0){ unit=''; }
  else if(u===1){ unit='han'; }
  else if(u===2){ unit='du'; }
  else if(u===3){ unit='se'; }
  else if(u===4){ unit='ne'; }
  else { unit=N_UNITS_RR[u]; }
  return (tens + (tens && unit? ' ' : '') + unit).trim() || 'yeong';
}
function formatCountKO(n, unitObj){
  if(unitObj.system==='native') return `${nativeCountForm(n)} ${unitObj.ko}`;
  return `${toSino(n)} ${unitObj.ko}`;
}
function formatCountRR(n, unitObj){
  if(unitObj.system==='native') return `${romanizeNativeCount(n)} ${unitObj.rr}`;
  return `${romanizeSino(n)} ${unitObj.rr}`;
}

/* =================== DATE (Y/M/D) =================== */
function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); }
function dateToKo(y,m,d){ return `${toSinoYear(y)}년 ${toSino(m)}월 ${toSino(d)}일`; }
function dateToRR(y,m,d){ return `${romanizeYear(y)} nyeon ${romanizeSino(m)} wol ${romanizeSino(d)} il`; }
function formatDateDigits(y,m,d){ return `${String(y)}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }

/* =================== UTIL / STATE =================== */
const progressEl=document.getElementById('progress');
const flipWrap=document.getElementById('flipWrap');
const cardEl=document.getElementById('card');
const front=document.getElementById('front');
const back=document.getElementById('back');
const choicesGrid=document.getElementById('choicesGrid');
const toggleChoices=document.getElementById('toggleChoices');
const modeSelect=document.getElementById('modeSelect');
const sinoOptions=document.getElementById('sinoOptions');
const showNumLabel=document.getElementById('frontNumWrapLabel');
const showNumChk=document.getElementById('showNumber');
const countOptions=document.getElementById('countOptions');
const unitSelect=document.getElementById('unitSelect');
const dateOptions=document.getElementById('dateOptions');
const yearSelect=document.getElementById('yearSelect');
const monthSelect=document.getElementById('monthSelect');
const daySelect=document.getElementById('daySelect');
const applyDateBtn=document.getElementById('applyDateBtn');
const randDateBtn=document.getElementById('randDateBtn');

let queue=[], index=0, mode='native', showFrontNumber=false, isAnimating=false;
let score=0, lockedChoice=false;

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function digitsCount(n){ return String(Math.abs(n)).length; }
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function randomWithDigits(d, allowZero=false){ if(d===1){ return allowZero ? randInt(0,9) : randInt(1,9); } const min=Math.pow(10,d-1), max=Math.pow(10,d)-1; return randInt(min,max); }
function updateProgress(){ progressEl.textContent = `${Math.min(index+1, queue.length)} / ${queue.length} • Score: ${score}`; }
function resetScore(){ score=0; updateProgress(); }

function selectedSinoDigits(){ const r=document.querySelector('input[name="digits"]:checked'); return r? parseInt(r.value,10) : 1; }
function deckLength(){ if(mode==='sino'){ return 20; } if(mode==='native'){ return 20; } if(mode==='count'){ return 20; } if(mode==='date'){ return 12; } return 20; }

/* =================== DECK BUILDERS =================== */
function buildNativeDeck(){ const want=deckLength(); const pool=Array.from({length:100},(_,i)=>i); return shuffle(pool).slice(0,want); }
function buildSinoDeck(){ const d=selectedSinoDigits(), want=deckLength(), set=new Set(); let guard=0; while(set.size<want && guard<want*200){ let n=randomWithDigits(d,false); if(n<=MAX_SINO) set.add(n); guard++; } return Array.from(set); }
function buildTimeDeck(){ const want=deckLength(); const set=new Set(); while(set.size<want){ const h=randInt(0,23), m=randInt(0,59); set.add(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`); } return Array.from(set).map(s=>{const [hh,mm]=s.split(':').map(x=>+x); return {h:hh,m:mm};}); }
function buildCountDeck(){ const want=deckLength(); const items=[]; for(let i=0;i<want;i++){ let unitKey=unitSelect.value; if(unitKey==='random'){ const pick=COUNTERS[randInt(0,COUNTERS.length-1)]; unitKey=pick.key; }
  const unitObj=getUnitByKey(unitKey); const [min,max]=unitObj.range; const n=randInt(min,max); items.push({n,unitKey}); } return items; }
function randomValidDate(){ const y=randInt(1990,2035); const m=randInt(1,12); const dMax=daysInMonth(y,m); const d=randInt(1,dMax); return {y,m,d}; }
function buildDateDeck(){ const want=deckLength(); const arr=[]; for(let i=0;i<want;i++){ arr.push(randomValidDate()); } return arr; }

/* =================== CHOICES (4) =================== */
 toggleChoices.addEventListener('change', ()=>{ choicesGrid.style.display = toggleChoices.checked ? 'grid' : 'none'; });

function randomNativeWithDigits(d){ if(d===1) return randInt(0,9); return randInt(10,99); }
function randomSinoWithDigits(d){ return randomWithDigits(d,false); }
function generateChoices(item){
  if(mode==='time'){
    const {h, m} = item; const correctKo = timeToKo(h, m);
    const alts = [(h+1)%24, (h+6)%24, (h+11)%24].map(H => timeToKo(H, m));
    const uniq = Array.from(new Set([correctKo, ...alts])).slice(0,4);
    return shuffle(uniq).map(t => ({ text: t, correct: t === correctKo }));
  }
  if(mode==='count'){
    const {n, unitKey}=item; const unitObj=getUnitByKey(unitKey);
    const correct=formatCountKO(n, unitObj);
    const d=digitsCount(n); const pick=unitObj.system==='native'? ()=>randInt(1, Math.max(9, Math.min(99, (10**d)-1))) : ()=>randomSinoWithDigits(d);
    const set=new Set([n]); while(set.size<4){ set.add(pick()); }
    const opts=[...set].map(x=>formatCountKO(x, unitObj));
    return shuffle(opts.map(t=>({text:t, correct:t===correct})));
  }
  if(mode==='date'){
    const {y,m,d}=item; const correct=dateToKo(y,m,d);
    const alts=[]; const d1=Math.max(1, Math.min(daysInMonth(y,m), d+1)); const d2=Math.max(1, Math.min(daysInMonth(y,m), (d+7)>daysInMonth(y,m)? d-7 : d+7)); const m2=((m%12)+1); const y2= m===12? y+1 : y; const d3=Math.min(d, daysInMonth(y2,m2)); alts.push(dateToKo(y,m,d1)); alts.push(dateToKo(y,m,d2)); alts.push(dateToKo(y2,m2,d3));
    const uniq=Array.from(new Set([correct, ...alts])).slice(0,4);
    return shuffle(uniq).map(t=>({text:t, correct:t===correct}));
  }
  // native/sino numbers
  const n=item, d=digitsCount(n);
  const pick = mode==='native' ? ()=>randomNativeWithDigits(d) : ()=>randomSinoWithDigits(d);
  const set=new Set([n]); while(set.size<4){ set.add(pick()); }
  return shuffle([...set].map(x=>({text:x.toLocaleString('en-US'), correct:x===n})));
}

function renderChoicesForCurrent(){
  choicesGrid.innerHTML='';
  if(!toggleChoices.checked || !queue.length){ choicesGrid.style.display='none'; return; }
  choicesGrid.style.display='grid'; lockedChoice=false; const opts=generateChoices(queue[index]);
  for(const opt of opts){ const btn=document.createElement('button'); btn.type='button'; btn.className='choiceBtn'; btn.textContent=opt.text; btn.dataset.correct=opt.correct?'1':'0'; btn.addEventListener('click', (e)=>{ e.stopPropagation(); if(lockedChoice) return; lockedChoice=true; if(opt.correct){ btn.classList.add('correct'); score+=1; updateProgress(); }else{ btn.classList.add('wrong'); [...choicesGrid.children].forEach(ch=>{ if(ch.dataset.correct==='1') ch.classList.add('reveal'); }); } }); choicesGrid.appendChild(btn); }
}

/* =================== RENDERING =================== */
function koReadingNumber(n){ return mode==='native' ? toNative(n) : toSino(n); }
function koRomanNumber(n){ return mode==='native' ? romanizeNative(n) : romanizeSino(n); }
function chipsNumber(n){ return mode==='native' ? breakdownNative(n) : breakdownSino(n); }

function renderFrontNumber(n){
  const ko=koReadingNumber(n), numeral=n.toLocaleString('en-US');
  front.innerHTML = `
    <div class="ko-row">
      <div class="ko-big">${ko}</div>
      <button class="play-base" id="playBaseFront">🔊 Play</button>
    </div>
    ${showFrontNumber? `<div class="big-num" style="opacity:.75">${numeral}</div>` : ''}
    <div class="controls" style="margin-top:4px"><button class="btn" id="flipToBack">Flip</button></div>`;
  front.querySelector('#playBaseFront').addEventListener('click', e=>{ e.stopPropagation(); playKo(ko); });
  front.querySelector('#flipToBack').addEventListener('click', e=>{ e.stopPropagation(); flipWrap.classList.add('flipped'); });
}
function renderBackNumber(n){
  const ko=koReadingNumber(n), numeral=n.toLocaleString('en-US'), rom=koRomanNumber(n), chipList=chipsNumber(n);
  back.innerHTML = `
    <div class="big-num-hero">${numeral}</div>
    <ul class="enlines">
      <li><b>KOREAN:</b> <span class="ko-big" style="font-size:1.25rem">${ko}</span></li>
      <li><b>ROMANIZATION:</b> <span class="ko-big" style="font-size:1rem">${rom}</span></li>
    </ul>
    <div class="gloss">${chipList.map(c=>`<span class="gchunk"><span class="gko">${c.ko}</span><span class="gen">${c.num.toLocaleString('en-US')}</span></span>`).join('')}</div>
    <div class="controls" style="margin-top:4px">
      <button class="btn ghost" id="flipToFront">Back</button>
      <button class="btn" id="nextBtn">Next ▶</button>
      <button class="btn" id="playKoBack">🔊 Play</button>
    </div>`;
  back.querySelector('#nextBtn').addEventListener('click', e=>{ e.stopPropagation(); nextCardAnimated(); });
  back.querySelector('#flipToFront').addEventListener('click', e=>{ e.stopPropagation(); flipWrap.classList.remove('flipped'); });
  back.querySelector('#playKoBack').addEventListener('click', e=>{ e.stopPropagation(); playKo(ko); });
}

function renderFrontTime(t){
  const {h,m}=t, am=h<12, num12=formatTime12(h,m);
  front.innerHTML = `
    <div style="display:flex; flex-direction:column; align-items:center; gap:6px">
      <div style="display:flex; align-items:center; gap:6px; justify-content:center">
        <canvas id="clockFront" style="width:min(64vw,220px); height:min(64vw,220px); max-width:220px; max-height:220px; border-radius:50%; box-shadow:0 4px 14px rgba(56,189,248,.22);"></canvas>
        <span class="ampm">${am?'AM':'PM'}</span>
      </div>
      <div class="big-num" style="opacity:.95">${num12}</div>
    </div>
    <div class="controls" style="margin-top:6px"><button class="btn" id="flipToBack">Flip</button></div>`;
  drawClock(document.getElementById('clockFront'), h, m);
  front.querySelector('#flipToBack').addEventListener('click', e=>{ e.stopPropagation(); flipWrap.classList.add('flipped'); });
}

function renderBackTime(t){
  const {h,m}=t, num12=formatTime12(h,m), ko=timeToKo(h,m), rr=timeToRR(h,m), am=h<12;
  back.innerHTML = `
    <div class="big-num-hero">${num12}</div>
    <ul class="enlines">
      <li><b>KOREAN:</b> <span class="ko-big" style="font-size:1.2rem">${ko}</span></li>
      <li><b>ROMANIZATION:</b> <span class="ko-big" style="font-size:.98rem">${rr}</span></li>
    </ul>
    <div class="controls" style="margin-top:4px; gap:8px">
      <span class="ampm">${am?'AM':'PM'}</span>
      <button class="btn ghost" id="flipToFront">Back</button>
      <button class="btn" id="nextBtn">Next ▶</button>
      <button class="btn" id="playKoBack">🔊 Play</button>
    </div>`;
  back.querySelector('#nextBtn').addEventListener('click', e=>{ e.stopPropagation(); nextCardAnimated(); });
  back.querySelector('#flipToFront').addEventListener('click', e=>{ e.stopPropagation(); flipWrap.classList.remove('flipped'); });
  back.querySelector('#playKoBack').addEventListener('click', e=>{ e.stopPropagation(); playKo(ko); });
}

function renderFrontCount(it){
  const unitObj=getUnitByKey(it.unitKey);
  const ko=formatCountKO(it.n, unitObj);
  front.innerHTML = `
    <div class="ko-row">
      <div class="ko-big">${ko}</div>
      <button class="play-base" id="playBaseFront">🔊 Play</button>
    </div>
    ${showFrontNumber? `<div class="big-num" style="opacity:.8">${it.n.toLocaleString('en-US')} ${unitObj.en}</div>` : ''}
    <div class="controls" style="margin-top:4px"><button class="btn" id="flipToBack">Flip</button></div>`;
  front.querySelector('#playBaseFront').addEventListener('click', e=>{ e.stopPropagation(); playKo(ko); });
  front.querySelector('#flipToBack').addEventListener('click', e=>{ e.stopPropagation(); flipWrap.classList.add('flipped'); });
}
function renderBackCount(it){
  const unitObj=getUnitByKey(it.unitKey);
  const ko=formatCountKO(it.n, unitObj);
  const rr=formatCountRR(it.n, unitObj);
  const parts = unitObj.system==='native' ? breakdownNative(it.n) : breakdownSino(it.n);
  back.innerHTML = `
    <div class="big-num-hero">${it.n.toLocaleString('en-US')} — ${unitObj.en}</div>
    <ul class="enlines">
      <li><b>KOREAN:</b> <span class="ko-big" style="font-size:1.2rem">${ko}</span></li>
      <li><b>ROMANIZATION:</b> <span class="ko-big" style="font-size:1rem">${rr}</span></li>
    </ul>
    <div class="gloss">${parts.map(c=>`<span class=\"gchunk\"><span class=\"gko\">${c.ko}</span><span class=\"gen\">${c.num.toLocaleString('en-US')}</span></span>`).join('')}
      <span class="gchunk"><span class="gko">${unitObj.ko}</span><span class="gen">${unitObj.en}</span></span>
    </div>
    <div class="controls" style="margin-top:4px">
      <button class="btn ghost" id="flipToFront">Back</button>
      <button class="btn" id="nextBtn">Next ▶</button>
      <button class="btn" id="playKoBack">🔊 Play</button>
    </div>`;
  back.querySelector('#nextBtn').addEventListener('click', e=>{ e.stopPropagation(); nextCardAnimated(); });
  back.querySelector('#flipToFront').addEventListener('click', e=>{ e.stopPropagation(); flipWrap.classList.remove('flipped'); });
  back.querySelector('#playKoBack').addEventListener('click', e=>{ e.stopPropagation(); playKo(ko); });
}

function renderFrontDate(it){
  const digits=formatDateDigits(it.y,it.m,it.d);
  front.innerHTML = `
    <div style="display:flex; flex-direction:column; align-items:center; gap:6px">
      <div class="big-num" style="opacity:.95">${digits}</div>
    </div>
    <div class="controls" style="margin-top:6px"><button class="btn" id="flipToBack">Flip</button></div>`;
  front.querySelector('#flipToBack').addEventListener('click', e=>{ e.stopPropagation(); flipWrap.classList.add('flipped'); });
}
function renderBackDate(it){
  const digits=formatDateDigits(it.y,it.m,it.d);
  const ko=dateToKo(it.y,it.m,it.d);
  const rr=dateToRR(it.y,it.m,it.d);
  back.innerHTML = `
    <div class="big-num-hero">${digits}</div>
    <ul class="enlines">
      <li><b>KOREAN:</b> <span class="ko-big" style="font-size:1.2rem">${ko}</span></li>
      <li><b>ROMANIZATION:</b> <span class="ko-big" style="font-size:1rem">${rr}</span></li>
    </ul>
    <div class="controls" style="margin-top:4px">
      <button class="btn ghost" id="flipToFront">Back</button>
      <button class="btn" id="nextBtn">Next ▶</button>
      <button class="btn" id="playKoBack">🔊 Play</button>
    </div>`;
  back.querySelector('#nextBtn').addEventListener('click', e=>{ e.stopPropagation(); nextCardAnimated(); });
  back.querySelector('#flipToFront').addEventListener('click', e=>{ e.stopPropagation(); flipWrap.classList.remove('flipped'); });
  back.querySelector('#playKoBack').addEventListener('click', e=>{ e.stopPropagation(); playKo(ko); });
}

function renderCurrent(){
  const item=queue[index];
  if(mode==='time'){ renderFrontTime(item); renderBackTime(item); }
  else if(mode==='count'){ renderFrontCount(item); renderBackCount(item); }
  else if(mode==='date'){ renderFrontDate(item); renderBackDate(item); }
  else { renderFrontNumber(item); renderBackNumber(item); }
  renderChoicesForCurrent();
}

/* =================== FLOW =================== */
function buildDeck(){
  mode=modeSelect.value;
  sinoOptions.style.display = (mode==='sino') ? 'flex' : 'none';
  countOptions.style.display = (mode==='count') ? 'flex' : 'none';
  dateOptions.style.display = (mode==='date') ? 'flex' : 'none';
  const showControls = (mode!=='time'); // keep checkbox visible for numbers, count, date
  showNumLabel.style.display = showControls? 'inline-block':'none';
  showNumChk.style.display = showControls? 'inline-block':'none';
  showFrontNumber = showControls ? showNumChk.checked : false;

  if(mode==='native'){ queue=buildNativeDeck(); }
  else if(mode==='sino'){ queue=buildSinoDeck(); }
  else if(mode==='time'){ queue=buildTimeDeck(); }
  else if(mode==='count'){ queue=buildCountDeck(); }
  else { queue=buildDateDeck(); }

  index=0; resetScore();
  flipWrap.classList.remove('flipped');
  renderCurrent();
  if(mode==='native' || mode==='sino'){ playKo(koReadingNumber(queue[index])); }
  if(mode==='count'){ const it=queue[index]; playKo(formatCountKO(it.n, getUnitByKey(it.unitKey))); }
  if(mode==='date'){ const it=queue[index]; playKo(dateToKo(it.y,it.m,it.d)); }
}

function nextCardAnimated(){
  if(isAnimating) return;
  isAnimating=true; flipWrap.classList.add('animating','fly-exit');
  const onExitEnd=(e)=>{
    if(e.target!==cardEl) return;
    flipWrap.removeEventListener('animationend', onExitEnd);
    flipWrap.classList.remove('fly-exit');
    index++;
    if(index>=queue.length){
      flipWrap.classList.remove('animating');
      isAnimating=false;
      showFinish();
      return;
    }
    renderCurrent();
    flipWrap.classList.remove('flipped');
    updateProgress();
    flipWrap.classList.add('fly-enter');
    const onEnterEnd=(ev)=>{
      if(ev.target!==cardEl) return;
      flipWrap.removeEventListener('animationend', onEnterEnd);
      flipWrap.classList.remove('fly-enter','animating');
      isAnimating=false;
      if(mode==='native' || mode==='sino'){ playKo(koReadingNumber(queue[index])); }
      if(mode==='count'){ const it=queue[index]; playKo(formatCountKO(it.n, getUnitByKey(it.unitKey))); }
      if(mode==='date'){ const it=queue[index]; playKo(dateToKo(it.y,it.m,it.d)); }
    };
    flipWrap.addEventListener('animationend', onEnterEnd);
  };
  flipWrap.addEventListener('animationend', onExitEnd);
}

/* finish with score + restart (compact panel) */
function showFinish(){
  const panel=document.getElementById('finish'); panel.style.display='flex';
  panel.querySelector('.panel').innerHTML = `
    <h2 style="margin:0 0 6px;color:var(--ice-1)">Finished! 🎉</h2>
    <p style="margin:6px 0 10px;color:var(--ice-2);font-weight:800">Score: ${score} / ${queue.length}</p>
    <div class="controls"><button class="btn" id="restartBtn">Restart (Shuffle)</button></div>`;
  document.getElementById('restartBtn').addEventListener('click', ()=>{ panel.style.display='none'; buildDeck(); });
}

/* =================== EVENTS =================== */
flipWrap.addEventListener('click', ()=>{ if(!queue.length) return; if(!flipWrap.classList.contains('flipped')) flipWrap.classList.add('flipped'); else nextCardAnimated(); });
cardEl.addEventListener('keydown', (e)=>{
  if(e.code==='Enter'||e.code==='Space'){ e.preventDefault(); if(!flipWrap.classList.contains('flipped')) flipWrap.classList.add('flipped'); else nextCardAnimated(); }
  if(e.code==='ArrowRight'){ e.preventDefault(); nextCardAnimated(); }
  if(e.code==='ArrowLeft'){ e.preventDefault(); flipWrap.classList.remove('flipped'); }
});

modeSelect.addEventListener('change', buildDeck);
[...document.querySelectorAll('input[name="digits"]')].forEach(r=> r.addEventListener('change', ()=>{ if(modeSelect.value==='sino') buildDeck(); }));
showNumChk.addEventListener('change', ()=>{ showFrontNumber=showNumChk.checked; if(queue.length) renderCurrent(); });
unitSelect.addEventListener('change', ()=>{ if(modeSelect.value==='count') buildDeck(); });

/* Date dropdowns */
function fillYearMonthDay(){
  yearSelect.innerHTML=''; monthSelect.innerHTML=''; daySelect.innerHTML='';
  for(let y=1990;y<=2035;y++){ const opt=document.createElement('option'); opt.value=String(y); opt.textContent=String(y); if(y===2025) opt.selected=true; yearSelect.appendChild(opt); }
  for(let m=1;m<=12;m++){ const opt=document.createElement('option'); opt.value=String(m); opt.textContent=String(m); if(m===9) opt.selected=true; monthSelect.appendChild(opt); }
  updateDayOptions();
}
function updateDayOptions(){ const y=parseInt(yearSelect.value,10)||2025; const m=parseInt(monthSelect.value,10)||9; const max=daysInMonth(y,m); const cur=parseInt(daySelect.value,10)||1; daySelect.innerHTML=''; for(let d=1; d<=max; d++){ const opt=document.createElement('option'); opt.value=String(d); opt.textContent=String(d); if(d===Math.min(cur,max)) opt.selected=true; daySelect.appendChild(opt); } }
[yearSelect, monthSelect].forEach(el=> el.addEventListener('change', ()=>{ updateDayOptions(); if(modeSelect.value==='date'){ // live update current card
  if(queue.length){ queue[index]={ y:parseInt(yearSelect.value,10), m:parseInt(monthSelect.value,10), d:parseInt(daySelect.value,10)}; renderCurrent(); }
}}));
daySelect.addEventListener('change', ()=>{ if(modeSelect.value==='date' && queue.length){ queue[index]={ y:parseInt(yearSelect.value,10), m:parseInt(monthSelect.value,10), d:parseInt(daySelect.value,10)}; renderCurrent(); } });
applyDateBtn.addEventListener('click', ()=>{ if(modeSelect.value!=='date') return; if(!queue.length) queue.push({y:2025,m:9,d:6}); queue[index]={ y:parseInt(yearSelect.value,10), m:parseInt(monthSelect.value,10), d:parseInt(daySelect.value,10)}; renderCurrent(); });
randDateBtn.addEventListener('click', ()=>{ if(modeSelect.value!=='date') return; const r=randomValidDate(); if(!queue.length){ queue=[r]; index=0; } else { queue[index]=r; } yearSelect.value=String(r.y); monthSelect.value=String(r.m); updateDayOptions(); daySelect.value=String(r.d); renderCurrent(); });

/* mobile bar */
function speakCurrent(){ if(!queue.length) return; if(mode==='time'){ const t=queue[index]; playKo(timeToKo(t.h,t.m)); } else if(mode==='count'){ const it=queue[index]; playKo(formatCountKO(it.n, getUnitByKey(it.unitKey))); } else if(mode==='date'){ const it=queue[index]; playKo(dateToKo(it.y,it.m,it.d)); } else { playKo(koReadingNumber(queue[index])); } }
document.getElementById('mFlip').addEventListener('click', e=>{ e.stopPropagation(); if(!flipWrap.classList.contains('flipped')) flipWrap.classList.add('flipped'); else nextCardAnimated(); });
document.getElementById('mPlay').addEventListener('click', e=>{ e.stopPropagation(); speakCurrent(); });
document.getElementById('mNext').addEventListener('click', e=>{ e.stopPropagation(); nextCardAnimated(); });

/* init */
showFrontNumber = showNumChk.checked;
fillYearMonthDay();
buildDeck();
</script>

  <script>
  // Disable right click + select + drag + certain keys
  document.addEventListener("contextmenu", e=>e.preventDefault(), false);
  document.addEventListener("selectstart", e=>e.preventDefault(), false);
  document.addEventListener("dragstart", e=>e.preventDefault(), false);
  document.addEventListener("keydown", function(e){
    if (e.key === "F12" || (e.ctrlKey && ["u","s","c","x","v"].includes(e.key.toLowerCase()))) {
      e.preventDefault();
    }
  }, false);
  </script>
</body>
</html>
