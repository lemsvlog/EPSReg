<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flip Cards – Sky Blue Freeze (Sequential + Autoplay + Per-form Buttons)</title>
  <style>
    /* ===== Sky Blue Freeze Theme ===== */
    :root{
      --bg-1:#03121f; --bg-2:#0a1e2e;
      --ice-1:#ecfeff; --ice-2:#dbeafe; --ice-3:#bae6fd;
      --text:#eef6ff; --muted:#a9c3d9;
      --accent:#38bdf8; --accent-2:#0ea5e9;
      --cyan:#67e8f9; --cyan-2:#22d3ee; --navy:#0b2440;
      --ring:0 0 18px rgba(56,189,248,.55), 0 0 32px rgba(103,232,249,.35);
      --border:1px solid rgba(186,230,253,.30);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif; color:var(--text);
      min-height:100vh; display:flex; flex-direction:column; align-items:center; gap:12px;
      background:
        radial-gradient(1200px 800px at 5% -10%, rgba(56,189,248,.18), transparent 60%),
        radial-gradient(1200px 800px at 120% 110%, rgba(103,232,249,.16), transparent 60%),
        linear-gradient(180deg, var(--bg-1), #061a2b 65%, #04121e);
      position:relative; isolation:isolate; padding:22px 16px 42px;
    }
    body::before{
      content:""; position:fixed; inset:-20%;
      background: conic-gradient(from 200deg at 60% 40%, rgba(186,230,253,.12), rgba(34,211,238,.10), rgba(56,189,248,.14), rgba(186,230,253,.10), rgba(34,211,238,.10));
      filter:blur(48px); animation: drift 20s linear infinite; z-index:-1; opacity:.9;
    }
    @keyframes drift{0%{transform:translate3d(0,0,0) rotate(0) scale(1)}50%{transform:translate3d(-3%,1%,0) rotate(10deg) scale(1.05)}100%{transform:translate3d(0,0,0) rotate(0) scale(1)}}

    header{text-align:center}
    .title{
      margin:0; font-size:2.2rem; font-weight:900; letter-spacing:2px; text-transform:uppercase;
      background:linear-gradient(180deg, var(--ice-1), var(--ice-2) 55%, var(--ice-3));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      text-shadow:0 0 10px rgba(255,255,255,.75),0 0 24px rgba(56,189,248,.45);
    }
    .subtitle{ margin:4px 0 0; color:var(--muted); font-weight:600 }
    .progress{ margin-top:6px; font-weight:800; color:var(--ice-2) }

    /* ===== Filter Segmented Buttons ===== */
    .filters{
      display:flex; gap:8px; justify-content:center; align-items:center;
      margin:8px 0 0; flex-wrap:wrap;
    }
    .seg{
      appearance:none; border:1px solid rgba(186,230,253,.35);
      background:linear-gradient(180deg, #071c2c, #061725);
      color:var(--ice-1); padding:8px 12px; border-radius:12px; font-weight:900;
      cursor:pointer; box-shadow:0 6px 18px rgba(56,189,248,.20);
      transition:filter .18s ease, transform .12s ease, box-shadow .18s ease;
    }
    .seg:hover{ filter:brightness(1.08); transform:translateY(-1px) }
    .seg.active{
      border-color:rgba(56,189,248,.9);
      box-shadow:0 0 0 3px rgba(56,189,248,.8), 0 0 28px rgba(56,189,248,.6);
      background:linear-gradient(180deg,#0b2a42,#08314e);
      color:var(--ice-1);
    }
    /* Subfilters row */
    .subfilters{
      display:none; gap:8px; justify-content:center; align-items:center; margin:6px 0 0; flex-wrap:wrap;
    }
    .subfilters.active{ display:flex; }

    .stage{ width:min(520px, 94vw); height:400px; display:flex; align-items:center; justify-content:center; margin-top:10px; }
    .flip{ perspective:1200px; width:100%; height:100%; }
    .card{ position:relative; width:100%; height:100%; transform-style:preserve-3d; transition: transform .75s cubic-bezier(.2,.7,.2,1); }
    .flipped .card{ transform:rotateY(180deg); }

    .face{ position:absolute; inset:0; border-radius:18px; backface-visibility:hidden; overflow:hidden; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; text-align:center; padding:18px; }
    .front{ color:#0c253a; background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.88)); border:1px solid rgba(255,255,255,.65); box-shadow:0 12px 26px rgba(2,12,22,.45); }
    .back{ transform:rotateY(180deg); background: linear-gradient(180deg, rgba(10,30,46,.86), rgba(7,22,36,.94)); border:var(--border); box-shadow:var(--ring); }

    .ko{ font-size:2.2rem; font-weight:900; letter-spacing:.5px; text-shadow:0 1px 0 rgba(255,255,255,.7); color:#0c253a }

    .ko-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; width:min(460px,96%); }
    .play-base{ appearance:none; border:none; cursor:pointer; border-radius:10px; padding:8px 12px; font-weight:900; color:#072235; background:linear-gradient(90deg, var(--cyan), var(--accent)); box-shadow:0 6px 18px rgba(56,189,248,.35); }
    .play-base:hover{ filter:brightness(1.08) }

    .forms{ width:min(460px,96%); margin:4px auto 0; padding:0; list-style:none; text-align:left; }
    .forms li{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; margin:8px 0; border-radius:12px; background:linear-gradient(180deg, #071c2c, #061725); border:1px solid rgba(186,230,253,.2); color:var(--ice-2) }
    .forms .left{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .forms b{ color:var(--ice-3) }
    .play-mini{ flex:0 0 auto; appearance:none; border:none; cursor:pointer; border-radius:10px; padding:8px 10px; font-weight:900; color:#072235; background:linear-gradient(90deg, var(--cyan), var(--accent)); box-shadow:0 6px 18px rgba(56,189,248,.35); }
    .play-mini:hover{ filter:brightness(1.08) }

    .enhead{ font-size:1.2rem; font-weight:900; color:var(--ice-1); margin-top:6px; text-align:left; width:min(460px,96%); }
    .enlines{ width:min(460px,96%); margin:6px auto 0; padding:0; list-style:none; text-align:left; }
    .enlines li{ padding:8px 10px; margin:6px 0; border-radius:12px; background:linear-gradient(180deg, #071c2c, #061725); border:1px solid rgba(186,230,253,.2); color:var(--ice-2) }
    .enlines b{ color:var(--ice-3) }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:0 }
    .btn{ appearance:none; border:none; cursor:pointer; font-weight:900; letter-spacing:.3px; border-radius:12px; padding:10px 14px; color:#072235; background:linear-gradient(90deg, var(--cyan), var(--accent)); box-shadow:0 6px 18px rgba(56,189,248,.35); transition:transform .12s ease, filter .2s ease, box-shadow .2s ease }
    .btn:hover{ filter:brightness(1.08); transform:translateY(-1px); box-shadow:var(--ring) }
    .ghost{ background:transparent; color:var(--ice-2); border:1px solid rgba(186,230,253,.35) }

    .gate, .finish{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(1,7,13,.55); backdrop-filter: blur(6px) saturate(130%); -webkit-backdrop-filter: blur(6px) saturate(130%); z-index:5; }
    .panel{ width:min(520px,92vw); background: linear-gradient(180deg, rgba(10,30,46,.86), rgba(7,22,36,.94)); border:var(--border); border-radius:16px; padding:20px; text-align:center; box-shadow:var(--ring); }
    .panel h2{ margin:0 0 8px; font-size:22px; font-weight:900; color:var(--ice-1) }
    .panel p{ margin:6px 0 14px; color:var(--muted) }

    @media (max-width:768px){ .stage{ height:420px } .ko{ font-size:2.4rem } }

    .flip.animating{ pointer-events:none; }
    @keyframes flyOut{ from{opacity:1; transform:translate3d(0,0,0) scale(1)} to{opacity:0; transform:translate3d(60vw,-6vh,0) rotate(8deg) scale(.96)} }
    @keyframes flyIn{ from{opacity:0; transform:translate3d(-60vw,6vh,0) rotate(-6deg) scale(.96)} to{opacity:1; transform:translate3d(0,0,0) rotate(0) scale(1)} }
    .flip.fly-exit .card{ animation: flyOut .10s cubic-bezier(.2,.7,.2,1) forwards; }
    .flip.fly-enter .card{ animation: flyIn .10s cubic-bezier(.2,.7,.2,1) forwards; }

    #flipToFront{
      background: linear-gradient(90deg, #a78bfa, #60a5fa) !important; color:#07162a !important; border:none !important;
      font-weight:900; letter-spacing:.6px; text-transform:uppercase;
      box-shadow:0 10px 26px rgba(96,165,250,.45), 0 0 26px rgba(167,139,250,.35);
    }
    #flipToFront:hover{ filter:brightness(1.08); box-shadow:0 0 22px rgba(96,165,250,.65), 0 0 34px rgba(167,139,250,.45); }

    /* 3D icy flip button (front) */
    #flipToBack{
      position:relative; padding:14px 22px !important; border-radius:16px;
      border:1px solid rgba(255,255,255,.75) !important; border-bottom-color:rgba(10,60,90,.45) !important; border-right-color:rgba(10,60,90,.35) !important;
      background:linear-gradient(180deg, rgba(236,254,255,.98) 0%, rgba(219,234,254,.96) 38%, rgba(56,189,248,.93) 100%) !important;
      color:#062136 !important; text-transform:uppercase; letter-spacing:.8px; font-weight:900;
      box-shadow:0 14px 28px rgba(56,189,248,.35), 0 6px 0 rgba(6,26,43,.65), inset 0 1px 0 rgba(255,255,255,.95), inset 0 -8px 20px rgba(7,34,53,.25);
      transform:translateY(-1px); transition:transform .18s ease, box-shadow .22s ease, filter .22s ease; overflow:hidden; isolation:isolate;
    }
    #flipToBack::before{
      content:""; position:absolute; inset:2px 2px 10px 2px; border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,0) 60%); pointer-events:none; mix-blend-mode:screen;
    }
    #flipToBack::after{
      content:""; position:absolute; inset:-45% -70%;
      background:
        radial-gradient(12px 12px at 22% 32%, rgba(255,255,255,.85), transparent 60%),
        radial-gradient(10px 10px at 72% 65%, rgba(255,255,255,.55), transparent 60%),
        linear-gradient(115deg, rgba(255,255,255,0) 35%, rgba(255,255,255,.45) 50%, rgba(255,255,255,0) 65%);
      transform:translateX(-120%) rotate(8deg); animation:icySweep 2.6s ease-in-out infinite; pointer-events:none; mix-blend-mode:screen;
    }
    #flipToBack:hover{
      filter:brightness(1.06); transform:translateY(-3px);
      box-shadow:0 18px 36px rgba(56,189,248,.45), 0 8px 0 rgba(6,26,43,.6), inset 0 1px 0 rgba(255,255,255,1), inset 0 -10px 24px rgba(7,34,53,.28);
    }
    #flipToBack:active{
      transform:translateY(0);
      box-shadow:0 8px 16px rgba(56,189,248,.35), 0 3px 0 rgba(6,26,43,.7), inset 0 1px 0 rgba(255,255,255,.95), inset 0 -6px 16px rgba(7,34,53,.28);
    }
    @keyframes icySweep{ 0%{transform:translateX(-120%) rotate(8deg); opacity:.95} 50%{opacity:1} 100%{transform:translateX(120%) rotate(8deg); opacity:.95} }

    /* Emphasis for Korean forms */
    .koform{ font-size:1.38rem; font-weight:300; letter-spacing:.3px; color:var(--ice-1); }
    @media (max-width:420px){ .koform{ font-size:1.18rem; } }

    /* Floating Home Button */
    .floating-home {
      position: fixed; top: 0; right: 0;
      background: linear-gradient(90deg, var(--cyan), var(--accent));
      color: #072235; font-size: 14px; font-weight: 700; text-decoration: none;
      padding: 8px 16px; border-radius: 0 0 0 10px; box-shadow: 0 6px 18px rgba(56,189,248,.35);
      z-index: 9999; transition: all 0.25s ease; backdrop-filter: blur(8px) saturate(140%); -webkit-backdrop-filter: blur(8px) saturate(140%);
    }
    .floating-home:hover{ filter:brightness(1.12); box-shadow: 0 0 12px rgba(56,189,248,.55), 0 0 24px rgba(103,232,249,.45); transform: translateY(-1px); }

    /* ===== Choices (4 boxes) ===== */
    .quiz{ width:min(520px,94vw); margin:4px auto 0; }
    .quiz .toggleRow{
      display:flex; align-items:center; justify-content:center; gap:10px; color:var(--ice-2); margin:4px 0 6px;
    }
    .choicesGrid{
      display:grid; grid-template-columns:repeat(2, minmax(140px,1fr)); gap:10px;
      width:min(460px,96%); margin:6px auto 0;
    }
    .choiceBtn{
      appearance:none; border:1px solid rgba(186,230,253,.35); background:linear-gradient(180deg,#071c2c,#061725);
      color:var(--ice-1); font-weight:800; padding:10px 12px; border-radius:12px; cursor:pointer; text-align:center;
      min-height:44px; box-shadow:0 6px 18px rgba(56,189,248,.20); transition:filter .18s ease, transform .12s ease, box-shadow .18s ease;
      user-select:none; font-size:.92rem;
    }
    .choiceBtn:hover{ filter:brightness(1.08); transform:translateY(-1px) }
    .choiceBtn.correct{
      border-color:rgba(56,189,248,.8);
      box-shadow:0 0 0 2px rgba(56,189,248,.55), 0 0 22px rgba(56,189,248,.45);
      background:linear-gradient(180deg,#0b2a42,#08314e);
    }
    .choiceBtn.reveal{
      border-color:rgba(56,189,248,.9);
      box-shadow:0 0 0 3px rgba(56,189,248,.8), 0 0 28px rgba(56,189,248,.6);
      background:linear-gradient(180deg,#0b2a42,#08314e);
    }
    @keyframes shakeX{
      0%,100%{transform:translateX(0)}
      20%{transform:translateX(-7px)} 40%{transform:translateX(7px)}
      60%{transform:translateX(-5px)} 80%{transform:translateX(5px)}
    }
    .choiceBtn.wrong{
      background:linear-gradient(180deg,#2b0a0a,#1a0707); border-color:rgba(255,99,132,.65);
      animation:shakeX .35s ease;
    }

    /* ===== Page/Book tag (Front, top) ===== */
    .meta-top{
      position:absolute; top:8px; left:12px; right:12px; text-align:center;
      font-weight:800; color:#000; opacity:.95; padding:4px 8px;
      border-radius:10px; border:1px solid rgba(0,0,0,.06);
      background:linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.55));
      pointer-events:none;
    }
	
	
	/* One-line subfilters (never wrap) */
.subfilters{
  display:none;
  gap:8px;
  align-items:center;
  justify-content:center;   /* center on wide screens */
  margin:6px 0 0;
  flex-wrap: nowrap;        /* <<< no wrapping */
  overflow-x: auto;         /* allow horizontal scroll if needed */
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
  padding: 2px 6px 6px;     /* little space for scrollbar */
}
.subfilters.active{ display:flex; }

/* Keep each button on one line and prevent shrinking */
.subfilters .seg{
  flex: 0 0 auto;           /* don’t shrink */
  white-space: nowrap;      /* keep label in one line */
}

/* On mobile, left-align so scrolling starts from the first item */
@media (max-width: 768px){
  .subfilters{ justify-content: flex-start; }
}

/* (Optional) nicer thin scrollbar */
.subfilters::-webkit-scrollbar{ height:6px }
.subfilters::-webkit-scrollbar-thumb{
  background: rgba(186,230,253,.35); border-radius:6px;
}
.subfilters::-webkit-scrollbar-track{ background: transparent }


  </style>
</head>
<body>
  <!-- Floating Home Button -->
  <a href="index.html" class="floating-home">Home</a>

  <header>
    <h1 class="title">VIZKOR Flip Cards</h1>
    <p class="subtitle">Korean BASIC Verb 145</p>
    <div class="progress" id="progress">&nbsp;</div>

    <!-- Top-level filters -->
    <div class="filters" role="tablist" aria-label="Filter deck">
      <button class="seg active" data-mode="all" aria-pressed="true">All</button>
      <button class="seg" data-mode="1" aria-pressed="false">Book 1</button>
      <button class="seg" data-mode="2" aria-pressed="false">Book 2</button>
    </div>

    <!-- Subfilters (dynamic per book) -->
    <div id="subfilters" class="subfilters" role="tablist" aria-label="Range filter"></div>
  </header>

  <section class="stage">
    <div class="flip" id="flipWrap" aria-live="polite">
      <div class="card" id="card" tabindex="0" aria-label="Flip card">
        <section class="face front" id="front"></section>
        <section class="face back" id="back"></section>
      </div>
    </div>
  </section>

  <!-- ===== Choices UI (toggle + 4 boxes) ===== -->
  <section class="quiz" id="quiz">
    <div class="toggleRow">
      <input type="checkbox" id="toggleChoices" checked />
      <label for="toggleChoices">Show choices (English meaning)</label>
    </div>
    <div id="choicesGrid" class="choicesGrid" role="group" aria-label="Choices"></div>
  </section>

  <div class="gate" id="gate">
    <div class="panel">
      <h2>Start Practice</h2>
      <p>Enable audio first. Then each card autoplays the base Korean once. Use ▶ for forms, 🔊 to replay base, and FLIP to view English + Tagalog.</p>
      <div class="controls"><button class="btn" id="startBtn">Start (Enable Audio)</button></div>
    </div>
  </div>

  <div class="finish" id="finish" style="display:none">
    <div class="panel">
      <h2>Finished! 🎉</h2>
      <p>Na-randomize na lahat. Gusto mo bang ulitin (reshuffle)?</p>
      <div class="controls"><button class="btn" id="restartBtn">Restart (Shuffle)</button></div>
    </div>
  </div>

  <audio id="koAudio" preload="auto"></audio>

  <script src="verb.js"></script>

  <script>
    // ===== State & Elements =====
    let queue = []; let current = null; let index = 0; let audioReady = false;
    const gate = document.getElementById('gate');
    const finish = document.getElementById('finish');
    const progressEl = document.getElementById('progress');
    const flipWrap = document.getElementById('flipWrap');
    const cardEl = document.getElementById('card');
    const front = document.getElementById('front');
    const back  = document.getElementById('back');
    const player = document.getElementById('koAudio');

    // Choices elements
    const choicesGrid = document.getElementById('choicesGrid');
    const toggleChoices = document.getElementById('toggleChoices');

    // Filters
    const filterButtons = document.querySelectorAll('.filters .seg');
    const subfilters = document.getElementById('subfilters');

    let filterMode = 'all';     // 'all' | '1' | '2'
    let subMode = 'all';        // 'all' | '1-100' | '101-200' | '201-288' | '201-339'
    let WORDS_POOL = [];        // active filtered set

    let isAnimating = false;

    // ===== Utils =====
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
    function updateProgress(){
      const total = queue.length || (WORDS_POOL.length || WORDS_MASTER.length);
      progressEl.textContent = `${Math.min(index+1, total)} / ${total}`;
    }

    // ===== TTS =====
const VOICERSS_KEY = "YOUR_VOICERSS_KEY_HERE";
const audioCache = new Map();
const koTtsUrl = (text)=>`https://api.voicerss.org/?key=${VOICERSS_KEY}&hl=ko-kr&c=MP3&f=48khz_16bit_mono&src=${encodeURIComponent(text)}`;

// NEW: normalize Korean for TTS (remove parentheses but keep the inside)
function normalizeKoForTTS(text){
  if(!text) return text;
  let out = String(text);

  // Combine content inside parentheses with surrounding text:
  // "공부(하다)" -> "공부하다", "(을)" -> "을"
  out = out.replace(/\s*\(([^)]+)\)\s*/g, '$1');

  // Remove any stray parentheses that might remain
  out = out.replace(/[()]/g, '');

  // Optional: collapse extra spaces (safety)
  out = out.replace(/\s{2,}/g, ' ').trim();

  return out;
}

function speakWeb(text){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'ko-KR';
  u.rate = 0.95;
  try{ speechSynthesis.cancel(); }catch(e){}
  speechSynthesis.speak(u);
}

// UPDATED: always TTS the normalized string (parentheses ignored)
async function playKo(text){
  if(!audioReady) return;

  const spoken = normalizeKoForTTS(text);

  if(!VOICERSS_KEY || VOICERSS_KEY === "YOUR_VOICERSS_KEY_HERE"){
    speakWeb(spoken);
    return;
  }
  let url = audioCache.get(spoken);
  if(!url){
    url = koTtsUrl(spoken);
    audioCache.set(spoken, url);
  }
  player.src = url;
  try{
    await player.play();
  }catch(e){
    console.warn("VoiceRSS play failed; falling back to Web Speech:", e);
    speakWeb(spoken);
  }
}


    // ===== Choices (4 small boxes) =====
    function getChoiceEnglish(word){
      const raw = (word && word.en) ? String(word.en) : '';
      return raw.split('/')[0].trim();
    }
    function generateChoicesFor(currentWord){
      const correct = getChoiceEnglish(currentWord);
      const pool = [];
      const source = (WORDS_POOL && WORDS_POOL.length) ? WORDS_POOL : WORDS_MASTER;
      for(const w of source){
        const eng = getChoiceEnglish(w);
        if(eng && eng !== correct && !pool.includes(eng)) pool.push(eng);
      }
      shuffle(pool);
      const distractors = pool.slice(0,3);
      return shuffle([correct, ...distractors]).map(text => ({ text, correct: text === correct }));
    }

    function renderChoicesFor(word){
      choicesGrid.innerHTML = '';
      if(!toggleChoices.checked) { choicesGrid.style.display = 'none'; return; }
      choicesGrid.style.display = 'grid';
      const options = generateChoicesFor(word);
      let locked = false;

      for(const opt of options){
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'choiceBtn';
        btn.textContent = opt.text;
        btn.dataset.correct = opt.correct ? '1' : '0';
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          if(locked) return;
          locked = true;
          if(opt.correct){
            btn.classList.add('correct');
          }else{
            btn.classList.add('wrong');
            [...choicesGrid.children].forEach(ch=>{ if(ch.dataset.correct === '1'){ ch.classList.add('reveal'); } });
          }
        });
        choicesGrid.appendChild(btn);
      }
    }

    toggleChoices.addEventListener('change', ()=>{
      if(!current) return;
      renderChoicesFor(current);
    });

    // ===== Rendering =====
    function renderFront(w){
      front.innerHTML = `
        <div class="meta-top">Page ${w.page} • Book ${w.book}</div>
        <div class="ko-row">
          <div class="ko">${w.ko}</div>
          <button class="play-base" id="playBaseFront" title="Play base" aria-label="Play base">🔊 Play</button>
        </div>
        <ul class="forms">
          <li>
            <span class="left"><b>Present</b> <span class="koform">${w.present.ko}</span></span>
            <button class="play-mini" data-tts="${w.present.ko}" aria-label="Play Present">Play ▶</button>
          </li>
          <li>
            <span class="left"><b>Past</b> <span class="koform">${w.past.ko}</span></span>
            <button class="play-mini" data-tts="${w.past.ko}" aria-label="Play Past">Play ▶</button>
          </li>
          <li>
            <span class="left"><b>Future</b> <span class="koform">${w.future.ko}</span></span>
            <button class="play-mini" data-tts="${w.future.ko}" aria-label="Play Future">Play ▶</button>
          </li>
        </ul>
        <div class="controls" style="margin-top:6px">
          <button class="btn ghost" id="flipToBack"> FLIP the CARD</button>
        </div>`;
      front.querySelector('#playBaseFront').addEventListener('click', (e)=>{ e.stopPropagation(); playKo(w.ko); });
      front.querySelectorAll('.play-mini').forEach(btn=>{
        btn.addEventListener('click', (e)=>{ e.stopPropagation(); playKo(btn.dataset.tts); });
      });
      front.querySelector('#flipToBack').addEventListener('click', (e)=>{ e.stopPropagation(); flipWrap.classList.add('flipped'); });
    }

    function renderBack(w){
      const lines = { present: w.present.en, past: w.past.en, future: w.future.en };
      back.innerHTML = `
        <div class="enhead">${w.ko} - ${w.en}</div>
        <ul class="enlines">
          <li><b>Present</b> <span class="koform">${w.present.ko}</span> - ${lines.present}</li>
          <li><b>Past</b>    <span class="koform">${w.past.ko}</span>    - ${lines.past}</li>
          <li><b>Future</b>  <span class="koform">${w.future.ko}</span>  - ${lines.future}</li>
        </ul>
        <div class="controls" style="margin-top:6px">
          <button class="btn ghost" id="flipToFront">◀ Back</button>
          <button class="btn" id="nextBtn">Next ▶</button>
          <button class="btn" id="playBaseBack">🔊 Play Base</button>
        </div>`;
      back.querySelector('#nextBtn').addEventListener('click', (e)=>{ e.stopPropagation(); nextCardAnimated(); });
      back.querySelector('#playBaseBack').addEventListener('click', (e)=>{ e.stopPropagation(); playKo(w.ko); });
      back.querySelector('#flipToFront').addEventListener('click', (e)=>{ e.stopPropagation(); flipWrap.classList.remove('flipped'); });
    }

    function showCard(w){
      current = w;
      renderFront(w);
      renderBack(w);
      flipWrap.classList.remove('flipped');
      updateProgress();
      renderChoicesFor(w);
      playKo(w.ko);
    }

    function showEmpty(){
      current = null;
      flipWrap.classList.remove('flipped');
      front.innerHTML = `
        <div class="meta-top">No items for this filter</div>
        <div class="ko-row" style="justify-content:center">
          <div class="ko" style="color:#789; text-shadow:none">— Empty —</div>
        </div>`;
      back.innerHTML = '';
      choicesGrid.innerHTML = '';
      updateProgress();
    }

    // ===== Filter helpers =====
    function setActiveFilterButton(mode){
      filterButtons.forEach(btn=>{
        const active = btn.dataset.mode === mode;
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
      });
    }

    function setActiveSubButton(mode){
      [...subfilters.querySelectorAll('.seg')].forEach(btn=>{
        const active = btn.dataset.sub === mode;
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
      });
    }

    function buildSubfilters(){
      subfilters.innerHTML = '';
      subfilters.classList.remove('active');

      if(filterMode === '1'){
        subfilters.classList.add('active');
        addSubBtn('all', 'All (Book 1)');
        addSubBtn('1-100', '1–100 (Basic)');
        addSubBtn('101-200', '101–200');
        addSubBtn('201-288', '201–288 (Last)');
      }else if(filterMode === '2'){
        subfilters.classList.add('active');
        addSubBtn('all', 'All (Book 2)');
        addSubBtn('1-100', '1–100 (Basic)');
        addSubBtn('101-200', '101–200');
        addSubBtn('201-339', '201–339 (Last)');
      }

      function addSubBtn(code, label){
        const b = document.createElement('button');
        b.className = 'seg' + (subMode===code ? ' active':'');
        b.dataset.sub = code;
        b.setAttribute('aria-pressed', subMode===code ? 'true':'false');
        b.textContent = label;
        b.addEventListener('click', (e)=>{
          e.preventDefault();
          applySubFilter(code);
        });
        subfilters.appendChild(b);
      }
    }

    function sliceByRange(list, start, end){
      const s = Math.max(0, start);
      const e = Math.min(end, list.length);
      return (s < e) ? list.slice(s, e) : [];
    }

    function getFilteredWords(){
      if(filterMode === 'all') return [...WORDS_MASTER];

      const bookNum = Number(filterMode);
      const inBook = WORDS_MASTER.filter(w => Number(w.book) === bookNum);

      if(subMode === 'all') return inBook;

      // Fixed ranges; clamp to list length
      if(bookNum === 1){
        if(subMode === '1-100')   return sliceByRange(inBook, 0, 100);
        if(subMode === '101-200') return sliceByRange(inBook, 100, 200);
        if(subMode === '201-288') return sliceByRange(inBook, 200, 288);
      }else if(bookNum === 2){
        if(subMode === '1-100')   return sliceByRange(inBook, 0, 100);
        if(subMode === '101-200') return sliceByRange(inBook, 100, 200);
        if(subMode === '201-339') return sliceByRange(inBook, 200, 339);
      }
      return inBook; // fallback
    }

    function applyFilter(mode){
      filterMode = mode;
      subMode = 'all';               // reset sub-range when switching books/top filter
      setActiveFilterButton(mode);
      buildSubfilters();
      WORDS_POOL = getFilteredWords();
      index = 0;
      finish.style.display = 'none';
      queue = shuffle([...WORDS_POOL]);
      if(queue.length){ showCard(queue[0]); } else { showEmpty(); }
    }

    function applySubFilter(mode){
      subMode = mode;
      setActiveSubButton(mode);
      WORDS_POOL = getFilteredWords();
      index = 0;
      finish.style.display = 'none';
      queue = shuffle([...WORDS_POOL]);
      if(queue.length){ showCard(queue[0]); } else { showEmpty(); }
    }

    // Wire top-level filters
    filterButtons.forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        applyFilter(btn.dataset.mode);
      });
    });

    // ===== Flow =====
    function startRun(){
      WORDS_POOL = getFilteredWords();
      queue = shuffle([...WORDS_POOL]);
      index = 0;
      finish.style.display = 'none';
      if(queue.length){ showCard(queue[index]); } else { showEmpty(); }
    }

    function nextCardAnimated(){
      if(isAnimating) return;
      isAnimating = true;
      flipWrap.classList.add('animating','fly-exit');

      const onExitEnd = (e)=>{
        if(e.target !== cardEl) return;
        flipWrap.removeEventListener('animationend', onExitEnd);
        flipWrap.classList.remove('fly-exit');

        index++;
        if(index >= queue.length){
          flipWrap.classList.remove('animating');
          isAnimating = false;
          finish.style.display = 'flex';
          return;
        }

        const w = queue[index];
        renderFront(w);
        renderBack(w);
        flipWrap.classList.remove('flipped');
        updateProgress();
        renderChoicesFor(w);

        flipWrap.classList.add('fly-enter');
        const onEnterEnd = (ev)=>{
          if(ev.target !== cardEl) return;
          flipWrap.removeEventListener('animationend', onEnterEnd);
          flipWrap.classList.remove('fly-enter','animating');
          isAnimating = false;
          playKo(w.ko);
        };
        flipWrap.addEventListener('animationend', onEnterEnd);
      };
      flipWrap.addEventListener('animationend', onExitEnd);
    }

    // Click/tap behavior
    flipWrap.addEventListener('click', ()=>{
      if(!current) return;
      if(!flipWrap.classList.contains('flipped')) flipWrap.classList.add('flipped');
      else nextCardAnimated();
    });

    // Keyboard accessibility
    cardEl.addEventListener('keydown', (e)=>{
      if(e.code==='Enter' || e.code==='Space'){
        e.preventDefault();
        if(!flipWrap.classList.contains('flipped')) flipWrap.classList.add('flipped');
        else nextCardAnimated();
      }
    });

    // Start / Restart
    document.getElementById('startBtn').addEventListener('click', ()=>{ audioReady = true; gate.style.display = 'none'; startRun(); });
    document.getElementById('restartBtn').addEventListener('click', ()=>{ gate.style.display = 'none'; audioReady = true; startRun(); });

    // Initialize default view
    applyFilter('all');
  </script>

  <script>
    // Disable right click / selection / drag / certain keys
    document.addEventListener("contextmenu", e=>e.preventDefault(), false);
    document.addEventListener("selectstart", e=>e.preventDefault(), false);
    document.addEventListener("dragstart", e=>e.preventDefault(), false);
    document.addEventListener("keydown", function(e){
      if (e.key === "F12" || (e.ctrlKey && ["u","s","c","x","v"].includes(e.key.toLowerCase()))) { e.preventDefault(); }
    }, false);
  </script>
</body>
</html>
